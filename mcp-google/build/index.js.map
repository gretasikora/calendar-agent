{
  "version": 3,
  "sources": ["../src/index.ts", "../src/auth/client.ts", "../src/auth/utils.ts", "../src/auth/server.ts", "../src/auth/tokenManager.ts", "../src/handlers/listTools.ts", "../src/handlers/core/BaseToolHandler.ts", "../src/handlers/core/ListCalendarsHandler.ts", "../src/schemas/validators.ts", "../src/handlers/utils.ts", "../src/handlers/core/BatchRequestHandler.ts", "../src/handlers/core/ListEventsHandler.ts", "../src/handlers/core/SearchEventsHandler.ts", "../src/handlers/core/ListColorsHandler.ts", "../src/handlers/core/CreateEventHandler.ts", "../src/handlers/core/RecurringEventHelpers.ts", "../src/handlers/core/UpdateEventHandler.ts", "../src/handlers/core/DeleteEventHandler.ts", "../src/handlers/core/FreeBusyEventHandler.ts", "../src/handlers/core/contacts/ListContactsHandler.ts", "../src/handlers/core/contacts/GetContactHandler.ts", "../src/handlers/core/contacts/CreateContactHandler.ts", "../src/handlers/core/contacts/UpdateContactHandler.ts", "../src/handlers/core/contacts/DeleteContactHandler.ts", "../src/handlers/core/gmail/ListEmailsHandler.ts", "../src/handlers/core/gmail/GetEmailHandler.ts", "../src/handlers/core/gmail/SendEmailHandler.ts", "../src/handlers/core/gmail/UpdateEmailHandler.ts", "../src/handlers/core/gmail/utils/labelMutationBuilder.ts", "../src/handlers/core/gmail/DeleteEmailHandler.ts", "../src/handlers/core/gmail/CreateDraftHandler.ts", "../src/handlers/core/gmail/UpdateDraftHandler.ts", "../src/handlers/core/gmail/SendDraftHandler.ts", "../src/handlers/core/gmail/ListLabelsHandler.ts", "../src/handlers/core/gmail/CreateLabelHandler.ts", "../src/handlers/core/gmail/UpdateLabelHandler.ts", "../src/handlers/core/gmail/DeleteLabelHandler.ts", "../src/handlers/core/gmail/BatchUpdateEmailsHandler.ts", "../src/handlers/core/gmail/utils/rateLimiter.ts", "../src/handlers/callTool.ts"],
  "sourcesContent": ["import { Server } from \"@modelcontextprotocol/sdk/server/index.js\";\r\nimport { StdioServerTransport } from \"@modelcontextprotocol/sdk/server/stdio.js\";\r\nimport {\r\n  ListToolsRequestSchema,\r\n  CallToolRequestSchema,\r\n} from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { fileURLToPath } from \"url\";\r\nimport { readFileSync } from \"fs\";\r\nimport { join, dirname } from \"path\";\r\n\r\n// Import modular components\r\nimport { initializeOAuth2Client } from './auth/client.js';\r\nimport { AuthServer } from './auth/server.js';\r\nimport { TokenManager } from './auth/tokenManager.js';\r\nimport { getToolDefinitions } from './handlers/listTools.js';\r\nimport { handleCallTool } from './handlers/callTool.js';\r\n\r\n// Get package version\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\nconst packageJsonPath = join(__dirname, '..', 'package.json');\r\nconst packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));\r\nconst VERSION = packageJson.version;\r\n\r\n// --- Global Variables --- \r\n// Create server instance (global for export)\r\nconst server = new Server(\r\n  {\r\n    name: \"google-workspace\",\r\n    version: VERSION,\r\n  },\r\n  {\r\n    capabilities: {\r\n      tools: {},\r\n    },\r\n  }\r\n);\r\n\r\nlet oauth2Client: OAuth2Client;\r\nlet tokenManager: TokenManager;\r\nlet authServer: AuthServer;\r\n\r\n// --- Main Application Logic --- \r\nasync function main() {\r\n  try {\r\n    // 1. Initialize Authentication\r\n    oauth2Client = await initializeOAuth2Client();\r\n    tokenManager = new TokenManager(oauth2Client);\r\n    authServer = new AuthServer(oauth2Client);\r\n\r\n    // 2. Start auth server if authentication is required\r\n    // The start method internally validates tokens first\r\n    const authSuccess = await authServer.start();\r\n    if (!authSuccess) {\r\n      process.exit(1);\r\n    }\r\n\r\n    // 3. Set up MCP Handlers\r\n    \r\n    // List Tools Handler\r\n    server.setRequestHandler(ListToolsRequestSchema, async () => {\r\n      // Directly return the definitions from the handler module\r\n      return getToolDefinitions();\r\n    });\r\n\r\n    // Call Tool Handler\r\n    server.setRequestHandler(CallToolRequestSchema, async (request) => {\r\n      // Check if tokens are valid before handling the request\r\n      if (!(await tokenManager.validateTokens())) {\r\n        throw new Error(\"Authentication required. Please run 'npm run auth' to authenticate.\");\r\n      }\r\n      \r\n      // Delegate the actual tool execution to the specialized handler\r\n      return handleCallTool(request, oauth2Client);\r\n    });\r\n\r\n    // 4. Connect Server Transport\r\n    const transport = new StdioServerTransport();\r\n    await server.connect(transport);\r\n\r\n    // 5. Set up Graceful Shutdown\r\n    process.on(\"SIGINT\", cleanup);\r\n    process.on(\"SIGTERM\", cleanup);\r\n\r\n  } catch (error: unknown) {\r\n    process.stderr.write(`Server startup failed: ${error}\\n`);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// --- Cleanup Logic --- \r\nasync function cleanup() {\r\n  try {\r\n    if (authServer) {\r\n      // Attempt to stop the auth server if it exists and might be running\r\n      await authServer.stop();\r\n    }\r\n    process.exit(0);\r\n  } catch (error: unknown) {\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// --- Command Line Interface ---\r\nasync function runAuthServer(): Promise<void> {\r\n  // Use the same logic as auth-server.ts\r\n  try {\r\n    // Initialize OAuth client\r\n    const oauth2Client = await initializeOAuth2Client();\r\n\r\n    // Create and start the auth server\r\n    const authServerInstance = new AuthServer(oauth2Client);\r\n\r\n    // Start with browser opening (true by default)\r\n    const success = await authServerInstance.start(true);\r\n\r\n    if (!success && !authServerInstance.authCompletedSuccessfully) {\r\n      // Failed to start and tokens weren't already valid\r\n      console.error(\r\n        \"Authentication failed. Could not start server or validate existing tokens. Check port availability (3000-3004) and try again.\"\r\n      );\r\n      process.exit(1);\r\n    } else if (authServerInstance.authCompletedSuccessfully) {\r\n      // Auth was successful (either existing tokens were valid or flow completed just now)\r\n      console.log(\"Authentication successful.\");\r\n      process.exit(0); // Exit cleanly if auth is already done\r\n    }\r\n\r\n    // If we reach here, the server started and is waiting for the browser callback\r\n    console.log(\r\n      \"Authentication server started. Please complete the authentication in your browser...\"\r\n    );\r\n\r\n    // Wait for completion\r\n    const intervalId = setInterval(async () => {\r\n      if (authServerInstance.authCompletedSuccessfully) {\r\n        clearInterval(intervalId);\r\n        await authServerInstance.stop();\r\n        console.log(\"Authentication completed successfully!\");\r\n        process.exit(0);\r\n      }\r\n    }, 1000);\r\n  } catch (error) {\r\n    console.error(\"Authentication failed:\", error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nfunction showHelp(): void {\r\n  console.log(`\r\nGoogle Workspace MCP Server v${VERSION}\r\n\r\nUsage:\r\n  npx @cocal/google-calendar-mcp [command]\r\n\r\nCommands:\r\n  auth     Run the authentication flow\r\n  start    Start the MCP server (default)\r\n  version  Show version information\r\n  help     Show this help message\r\n\r\nExamples:\r\n  npx @cocal/google-calendar-mcp auth\r\n  npx @cocal/google-calendar-mcp start\r\n  npx @cocal/google-calendar-mcp version\r\n  npx @cocal/google-calendar-mcp\r\n\r\nEnvironment Variables:\r\n  GOOGLE_OAUTH_CREDENTIALS    Path to OAuth credentials file\r\n`);\r\n}\r\n\r\nfunction showVersion(): void {\r\n  console.log(`Google Workspace MCP Server v${VERSION}`);\r\n}\r\n\r\n// --- Exports & Execution Guard --- \r\n// Export server and main for testing or potential programmatic use\r\nexport { main, server, runAuthServer };\r\n\r\n// Parse CLI arguments\r\nfunction parseCliArgs(): { command: string | undefined } {\r\n  const args = process.argv.slice(2);\r\n  let command: string | undefined;\r\n\r\n  for (let i = 0; i < args.length; i++) {\r\n    const arg = args[i];\r\n    \r\n    // Handle special version/help flags as commands\r\n    if (arg === '--version' || arg === '-v' || arg === '--help' || arg === '-h') {\r\n      command = arg;\r\n      continue;\r\n    }\r\n    \r\n    // Check for command (first non-option argument)\r\n    if (!command && !arg.startsWith('--')) {\r\n      command = arg;\r\n      continue;\r\n    }\r\n  }\r\n\r\n  return { command };\r\n}\r\n\r\n// CLI logic here (run always)\r\nconst { command } = parseCliArgs();\r\n\r\nswitch (command) {\r\n  case \"auth\":\r\n    runAuthServer().catch((error) => {\r\n      console.error(\"Authentication failed:\", error);\r\n      process.exit(1);\r\n    });\r\n    break;\r\n  case \"start\":\r\n  case void 0:\r\n    main().catch((error) => {\r\n      process.stderr.write(`Failed to start server: ${error}\\n`);\r\n      process.exit(1);\r\n    });\r\n    break;\r\n  case \"version\":\r\n  case \"--version\":\r\n  case \"-v\":\r\n    showVersion();\r\n    break;\r\n  case \"help\":\r\n  case \"--help\":\r\n  case \"-h\":\r\n    showHelp();\r\n    break;\r\n  default:\r\n    console.error(`Unknown command: ${command}`);\r\n    showHelp();\r\n    process.exit(1);\r\n}", "import { OAuth2Client } from 'google-auth-library';\r\nimport * as fs from 'fs/promises';\r\nimport { getKeysFilePath, generateCredentialsErrorMessage, OAuthCredentials } from './utils.js';\r\n\r\nasync function loadCredentialsFromFile(): Promise<OAuthCredentials> {\r\n  const keysContent = await fs.readFile(getKeysFilePath(), \"utf-8\");\r\n  const keys = JSON.parse(keysContent);\r\n\r\n  if (keys.installed) {\r\n    // Standard OAuth credentials file format\r\n    const { client_id, client_secret, redirect_uris } = keys.installed;\r\n    return { client_id, client_secret, redirect_uris };\r\n  } else if (keys.client_id && keys.client_secret) {\r\n    // Direct format\r\n    return {\r\n      client_id: keys.client_id,\r\n      client_secret: keys.client_secret,\r\n      redirect_uris: keys.redirect_uris || ['http://localhost:3000/oauth2callback']\r\n    };\r\n  } else {\r\n    throw new Error('Invalid credentials file format. Expected either \"installed\" object or direct client_id/client_secret fields.');\r\n  }\r\n}\r\n\r\nasync function loadCredentialsWithFallback(): Promise<OAuthCredentials> {\r\n  // First check for direct environment variables\r\n  const clientId = process.env.GOOGLE_CLIENT_ID;\r\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET;\r\n  \r\n  if (clientId && clientSecret) {\r\n    // Use environment variables directly - no JSON file needed!\r\n    return {\r\n      client_id: clientId,\r\n      client_secret: clientSecret,\r\n      redirect_uris: ['http://localhost:3000/oauth2callback']\r\n    };\r\n  }\r\n  \r\n  // Otherwise, load credentials from file (CLI param, env var, or default path)\r\n  try {\r\n    return await loadCredentialsFromFile();\r\n  } catch (fileError) {\r\n    // Generate helpful error message\r\n    const errorMessage = generateCredentialsErrorMessage();\r\n    throw new Error(`${errorMessage}\\n\\nOriginal error: ${fileError instanceof Error ? fileError.message : fileError}`);\r\n  }\r\n}\r\n\r\nexport async function initializeOAuth2Client(): Promise<OAuth2Client> {\r\n  try {\r\n    const credentials = await loadCredentialsWithFallback();\r\n    \r\n    // Use the first redirect URI as the default for the base client\r\n    const oauth2Client = new OAuth2Client({\r\n      clientId: credentials.client_id,\r\n      clientSecret: credentials.client_secret,\r\n      redirectUri: credentials.redirect_uris[0],\r\n    });\r\n\r\n    return oauth2Client;\r\n  } catch (error) {\r\n    throw new Error(`Error loading OAuth keys: ${error instanceof Error ? error.message : error}`);\r\n  }\r\n}\r\n\r\nexport async function loadCredentials(): Promise<{ client_id: string; client_secret: string }> {\r\n  try {\r\n    const credentials = await loadCredentialsWithFallback();\r\n    \r\n    if (!credentials.client_id || !credentials.client_secret) {\r\n        throw new Error('Client ID or Client Secret missing in credentials.');\r\n    }\r\n    return {\r\n      client_id: credentials.client_id,\r\n      client_secret: credentials.client_secret\r\n    };\r\n  } catch (error) {\r\n    throw new Error(`Error loading credentials: ${error instanceof Error ? error.message : error}`);\r\n  }\r\n}", "import * as path from 'path';\r\nimport * as os from 'os';\r\nimport { fileURLToPath } from 'url';\r\n\r\n// Helper to get the project root directory reliably\r\nfunction getProjectRoot(): string {\r\n  const __dirname = path.dirname(fileURLToPath(import.meta.url));\r\n  // In build output (e.g., build/bundle.js), __dirname is .../build\r\n  // Go up ONE level to get the project root\r\n  const projectRoot = path.join(__dirname, \"..\"); // Corrected: Go up ONE level\r\n  return path.resolve(projectRoot); // Ensure absolute path\r\n}\r\n\r\n// Returns the absolute path for the saved token file.\r\n// Uses XDG Base Directory spec with fallback to home directory and legacy project root\r\nexport function getSecureTokenPath(): string {\r\n  // Check for custom token path environment variable first\r\n  const customTokenPath = process.env.GOOGLE_CALENDAR_MCP_TOKEN_PATH;\r\n  if (customTokenPath) {\r\n    return path.resolve(customTokenPath);\r\n  }\r\n\r\n  // Use XDG Base Directory spec or fallback to ~/.config\r\n  const configHome = process.env.XDG_CONFIG_HOME || \r\n    path.join(os.homedir(), '.config');\r\n  \r\n  const tokenDir = path.join(configHome, 'google-calendar-mcp');\r\n  return path.join(tokenDir, 'tokens.json');\r\n}\r\n\r\n// Returns the legacy token path for backward compatibility\r\nexport function getLegacyTokenPath(): string {\r\n  const projectRoot = getProjectRoot();\r\n  return path.join(projectRoot, \".gcp-saved-tokens.json\");\r\n}\r\n\r\n// Returns the absolute path for the GCP OAuth keys file with priority:\r\n// 1. Environment variable GOOGLE_OAUTH_CREDENTIALS (highest priority)\r\n// 2. Default file path (lowest priority)\r\nexport function getKeysFilePath(): string {\r\n  // Priority 1: Environment variable\r\n  const envCredentialsPath = process.env.GOOGLE_OAUTH_CREDENTIALS;\r\n  if (envCredentialsPath) {\r\n    return path.resolve(envCredentialsPath);\r\n  }\r\n  \r\n  // Priority 2: Default file path\r\n  const projectRoot = getProjectRoot();\r\n  const keysPath = path.join(projectRoot, \"gcp-oauth.keys.json\");\r\n  return keysPath; // Already absolute from getProjectRoot\r\n}\r\n\r\n// Interface for OAuth credentials\r\nexport interface OAuthCredentials {\r\n  client_id: string;\r\n  client_secret: string;\r\n  redirect_uris: string[];\r\n}\r\n\r\n// Generate helpful error message for missing credentials\r\nexport function generateCredentialsErrorMessage(): string {\r\n  return `\r\nOAuth credentials not found. Please provide credentials using one of these methods:\r\n\r\n1. Direct environment variables (simplest - no JSON file needed!):\r\n   Set GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET:\r\n   export GOOGLE_CLIENT_ID=\"your-client-id.apps.googleusercontent.com\"\r\n   export GOOGLE_CLIENT_SECRET=\"your-client-secret\"\r\n\r\n2. Credentials file via environment variable:\r\n   Set GOOGLE_OAUTH_CREDENTIALS to the path of your credentials file:\r\n   export GOOGLE_OAUTH_CREDENTIALS=\"/path/to/gcp-oauth.keys.json\"\r\n\r\n3. Default file path:\r\n   Place your gcp-oauth.keys.json file in the package root directory.\r\n\r\nToken storage:\r\n- Tokens are saved to: ${getSecureTokenPath()}\r\n- To use a custom token location, set GOOGLE_CALENDAR_MCP_TOKEN_PATH environment variable\r\n\r\nTo get OAuth credentials:\r\n1. Go to the Google Cloud Console (https://console.cloud.google.com/)\r\n2. Create or select a project\r\n3. Enable these APIs:\r\n   - Google Calendar API\r\n   - Google People API\r\n   - Gmail API\r\n4. Create OAuth 2.0 credentials (Desktop app type)\r\n5. Copy the Client ID and Client Secret\r\n`.trim();\r\n}", "import express from 'express';\r\nimport { OAuth2Client } from 'google-auth-library';\r\nimport { TokenManager } from './tokenManager.js';\r\nimport http from 'http';\r\nimport open from 'open';\r\nimport { loadCredentials } from './client.js';\r\n\r\nexport class AuthServer {\r\n  private baseOAuth2Client: OAuth2Client; // Used by TokenManager for validation/refresh\r\n  private flowOAuth2Client: OAuth2Client | null = null; // Used specifically for the auth code flow\r\n  private app: express.Express;\r\n  private server: http.Server | null = null;\r\n  private tokenManager: TokenManager;\r\n  private portRange: { start: number; end: number };\r\n  public authCompletedSuccessfully = false; // Flag for standalone script\r\n\r\n  constructor(oauth2Client: OAuth2Client) {\r\n    this.baseOAuth2Client = oauth2Client;\r\n    this.tokenManager = new TokenManager(oauth2Client);\r\n    this.app = express();\r\n    this.portRange = { start: 3000, end: 3004 };\r\n    this.setupRoutes();\r\n  }\r\n\r\n  private setupRoutes(): void {\r\n    this.app.get('/', (req, res) => {\r\n      // Generate the URL using the active flow client if available, else base\r\n      const clientForUrl = this.flowOAuth2Client || this.baseOAuth2Client;\r\n      const scopes = [\r\n        'https://www.googleapis.com/auth/calendar',\r\n        'https://www.googleapis.com/auth/contacts',\r\n        'https://www.googleapis.com/auth/gmail.modify',\r\n        'https://www.googleapis.com/auth/gmail.send',\r\n        'https://www.googleapis.com/auth/gmail.labels'\r\n      ];\r\n      const authUrl = clientForUrl.generateAuthUrl({\r\n        access_type: 'offline',\r\n        scope: scopes,\r\n        prompt: 'consent'\r\n      });\r\n      res.send(`\r\n        <!DOCTYPE html>\r\n        <html lang=\"en\">\r\n        <head>\r\n            <meta charset=\"UTF-8\">\r\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n            <title>Google Workspace MCP Authentication</title>\r\n            <style>\r\n                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f5f5f5; margin: 0; padding: 20px; }\r\n                .container { text-align: center; padding: 2.5em; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; }\r\n                h1 { color: #1a73e8; margin-bottom: 0.5em; }\r\n                h2 { color: #333; font-weight: normal; font-size: 1.2em; margin-bottom: 1.5em; }\r\n                p { color: #666; line-height: 1.6; margin-bottom: 1.5em; }\r\n                .btn { display: inline-block; background-color: #1a73e8; color: white; padding: 12px 32px; text-decoration: none; border-radius: 6px; font-size: 16px; font-weight: 500; transition: background-color 0.2s; }\r\n                .btn:hover { background-color: #1557b0; }\r\n                .permissions { background-color: #f8f9fa; padding: 1em; border-radius: 8px; margin: 1.5em 0; text-align: left; }\r\n                .permissions h3 { margin: 0 0 0.5em 0; font-size: 1em; color: #333; }\r\n                .permissions ul { margin: 0; padding-left: 1.5em; color: #666; }\r\n                .permissions li { margin: 0.3em 0; }\r\n                .footer { margin-top: 2em; font-size: 0.9em; color: #999; }\r\n            </style>\r\n        </head>\r\n        <body>\r\n            <div class=\"container\">\r\n                <h1>\uD83D\uDDD3\uFE0F Google Workspace MCP</h1>\r\n                <h2>Authentication Required</h2>\r\n                <p>Claude Desktop needs permission to access your Google Calendar, Contacts, and Gmail.</p>\r\n                \r\n                <div class=\"permissions\">\r\n                    <h3>This will allow Claude to:</h3>\r\n                    <ul>\r\n                        <li>View your calendar events</li>\r\n                        <li>Create new calendar events</li>\r\n                        <li>Update existing events</li>\r\n                        <li>Delete events</li>\r\n                        <li>Check your availability</li>\r\n                        <li>View and manage your contacts</li>\r\n                        <li>Create new contacts</li>\r\n                        <li>Update existing contacts</li>\r\n                        <li>Delete contacts</li>\r\n                        <li>Read and search your emails</li>\r\n                        <li>Send emails on your behalf</li>\r\n                        <li>Create and manage email drafts</li>\r\n                        <li>Organize emails with labels</li>\r\n                        <li>Mark emails as read/unread</li>\r\n                    </ul>\r\n                </div>\r\n                \r\n                <a href=\"${authUrl}\" class=\"btn\">Connect Google Workspace</a>\r\n                \r\n                <p class=\"footer\">You'll be redirected to Google to sign in securely.<br>Your credentials are never stored by this application.</p>\r\n            </div>\r\n        </body>\r\n        </html>\r\n      `);\r\n    });\r\n\r\n    this.app.get('/oauth2callback', async (req, res) => {\r\n      const code = req.query.code as string;\r\n      if (!code) {\r\n        res.status(400).send('Authorization code missing');\r\n        return;\r\n      }\r\n      // IMPORTANT: Use the flowOAuth2Client to exchange the code\r\n      if (!this.flowOAuth2Client) {\r\n        res.status(500).send('Authentication flow not properly initiated.');\r\n        return;\r\n      }\r\n      try {\r\n        const { tokens } = await this.flowOAuth2Client.getToken(code);\r\n        // Save tokens using the TokenManager (which uses the base client)\r\n        await this.tokenManager.saveTokens(tokens);\r\n        this.authCompletedSuccessfully = true;\r\n\r\n        // Get the path where tokens were saved\r\n        const tokenPath = this.tokenManager.getTokenPath();\r\n\r\n        // Send a more informative HTML response including the path\r\n        res.send(`\r\n          <!DOCTYPE html>\r\n          <html lang=\"en\">\r\n          <head>\r\n              <meta charset=\"UTF-8\">\r\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n              <title>Authentication Successful</title>\r\n              <style>\r\n                  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f4f4f4; margin: 0; }\r\n                  .container { text-align: center; padding: 2em; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\r\n                  h1 { color: #4CAF50; }\r\n                  p { color: #333; margin-bottom: 0.5em; }\r\n                  code { background-color: #eee; padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; }\r\n              </style>\r\n          </head>\r\n          <body>\r\n              <div class=\"container\">\r\n                  <h1>Authentication Successful!</h1>\r\n                  <p>Your authentication tokens have been saved successfully to:</p>\r\n                  <p><code>${tokenPath}</code></p>\r\n                  <p>You can now close this browser window.</p>\r\n              </div>\r\n          </body>\r\n          </html>\r\n        `);\r\n      } catch (error: unknown) {\r\n        this.authCompletedSuccessfully = false;\r\n        const message = error instanceof Error ? error.message : 'Unknown error';\r\n        // Send an HTML error response\r\n        res.status(500).send(`\r\n          <!DOCTYPE html>\r\n          <html lang=\"en\">\r\n          <head>\r\n              <meta charset=\"UTF-8\">\r\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n              <title>Authentication Failed</title>\r\n              <style>\r\n                  body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f4f4f4; margin: 0; }\r\n                  .container { text-align: center; padding: 2em; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\r\n                  h1 { color: #F44336; }\r\n                  p { color: #333; }\r\n              </style>\r\n          </head>\r\n          <body>\r\n              <div class=\"container\">\r\n                  <h1>Authentication Failed</h1>\r\n                  <p>An error occurred during authentication:</p>\r\n                  <p><code>${message}</code></p>\r\n                  <p>Please try again or check the server logs.</p>\r\n              </div>\r\n          </body>\r\n          </html>\r\n        `);\r\n      }\r\n    });\r\n  }\r\n\r\n  async start(openBrowser = true): Promise<boolean> {\r\n    if (await this.tokenManager.validateTokens()) {\r\n      this.authCompletedSuccessfully = true;\r\n      return true;\r\n    }\r\n    \r\n    // Try to start the server and get the port\r\n    const port = await this.startServerOnAvailablePort();\r\n    if (port === null) {\r\n      this.authCompletedSuccessfully = false;\r\n      return false;\r\n    }\r\n\r\n    // Successfully started server on `port`. Now create the flow-specific OAuth client.\r\n    try {\r\n      const { client_id, client_secret } = await loadCredentials();\r\n      this.flowOAuth2Client = new OAuth2Client(\r\n        client_id,\r\n        client_secret,\r\n        `http://localhost:${port}/oauth2callback`\r\n      );\r\n    } catch (error) {\r\n        // Could not load credentials, cannot proceed with auth flow\r\n        this.authCompletedSuccessfully = false;\r\n        await this.stop(); // Stop the server we just started\r\n        return false;\r\n    }\r\n\r\n    if (openBrowser) {\r\n      // Generate Auth URL using the newly created flow client\r\n      const authorizeUrl = this.flowOAuth2Client.generateAuthUrl({\r\n        access_type: 'offline',\r\n        scope: [\r\n          'https://www.googleapis.com/auth/calendar',\r\n          'https://www.googleapis.com/auth/contacts',\r\n          'https://www.googleapis.com/auth/gmail.modify',\r\n          'https://www.googleapis.com/auth/gmail.send',\r\n          'https://www.googleapis.com/auth/gmail.labels'\r\n        ],\r\n        prompt: 'consent'\r\n      });\r\n      await open(authorizeUrl);\r\n    }\r\n\r\n    return true; // Auth flow initiated\r\n  }\r\n\r\n  private async startServerOnAvailablePort(): Promise<number | null> {\r\n    for (let port = this.portRange.start; port <= this.portRange.end; port++) {\r\n      try {\r\n        await new Promise<void>((resolve, reject) => {\r\n          // Create a temporary server instance to test the port\r\n          const testServer = this.app.listen(port, () => {\r\n            this.server = testServer; // Assign to class property *only* if successful\r\n            resolve();\r\n          });\r\n          testServer.on('error', (err: NodeJS.ErrnoException) => {\r\n            if (err.code === 'EADDRINUSE') {\r\n              // Port is in use, close the test server and reject\r\n              testServer.close(() => reject(err)); \r\n            } else {\r\n              // Other error, reject\r\n              reject(err);\r\n            }\r\n          });\r\n        });\r\n        return port; // Port successfully bound\r\n      } catch (error: unknown) {\r\n        // Check if it's EADDRINUSE, otherwise rethrow or handle\r\n        if (!(error instanceof Error && 'code' in error && error.code === 'EADDRINUSE')) {\r\n            // An unexpected error occurred during server start\r\n            return null;\r\n        }\r\n        // EADDRINUSE occurred, loop continues\r\n      }\r\n    }\r\n    return null; // No port found\r\n  }\r\n\r\n  public getRunningPort(): number | null {\r\n    if (this.server) {\r\n      const address = this.server.address();\r\n      if (typeof address === 'object' && address !== null) {\r\n        return address.port;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  async stop(): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      if (this.server) {\r\n        this.server.close((err) => {\r\n          if (err) {\r\n            reject(err);\r\n          } else {\r\n            this.server = null;\r\n            resolve();\r\n          }\r\n        });\r\n      } else {\r\n        resolve();\r\n      }\r\n    });\r\n  }\r\n} ", "import { OAuth2Client, Credentials } from 'google-auth-library';\r\nimport * as fs from 'fs/promises';\r\nimport * as path from 'path';\r\nimport { getSecureTokenPath, getLegacyTokenPath } from './utils.js';\r\nimport { GaxiosError } from 'gaxios';\r\n\r\nexport class TokenManager {\r\n  private oauth2Client: OAuth2Client;\r\n  private tokenPath: string;\r\n\r\n  constructor(oauth2Client: OAuth2Client) {\r\n    this.oauth2Client = oauth2Client;\r\n    this.tokenPath = getSecureTokenPath();\r\n    this.setupTokenRefresh();\r\n  }\r\n\r\n  // Method to expose the token path\r\n  public getTokenPath(): string {\r\n    return this.tokenPath;\r\n  }\r\n\r\n  private async ensureTokenDirectoryExists(): Promise<void> {\r\n    try {\r\n        const dir = path.dirname(this.tokenPath);\r\n        await fs.mkdir(dir, { recursive: true });\r\n    } catch (error: unknown) {\r\n        // Ignore errors if directory already exists, re-throw others\r\n        if (error instanceof Error && 'code' in error && error.code !== 'EEXIST') {\r\n            console.error('Failed to create token directory:', error);\r\n            throw error;\r\n        }\r\n    }\r\n  }\r\n\r\n  private setupTokenRefresh(): void {\r\n    this.oauth2Client.on(\"tokens\", async (newTokens) => {\r\n      try {\r\n        await this.ensureTokenDirectoryExists();\r\n        const currentTokens = JSON.parse(await fs.readFile(this.tokenPath, \"utf-8\"));\r\n        const updatedTokens = {\r\n          ...currentTokens,\r\n          ...newTokens,\r\n          refresh_token: newTokens.refresh_token || currentTokens.refresh_token,\r\n        };\r\n        await fs.writeFile(this.tokenPath, JSON.stringify(updatedTokens, null, 2), {\r\n          mode: 0o600,\r\n        });\r\n        console.error(\"Tokens updated and saved\");\r\n      } catch (error: unknown) {\r\n        // Handle case where currentTokens might not exist yet\r\n        if (error instanceof Error && 'code' in error && error.code === 'ENOENT') { \r\n          try {\r\n             await fs.writeFile(this.tokenPath, JSON.stringify(newTokens, null, 2), { mode: 0o600 });\r\n             console.error(\"New tokens saved\");\r\n          } catch (writeError) {\r\n            console.error(\"Error saving initial tokens:\", writeError);\r\n          }\r\n        } else {\r\n            console.error(\"Error saving updated tokens:\", error);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private async migrateLegacyTokens(): Promise<boolean> {\r\n    const legacyPath = getLegacyTokenPath();\r\n    try {\r\n      // Check if legacy tokens exist\r\n      if (!(await fs.access(legacyPath).then(() => true).catch(() => false))) {\r\n        return false; // No legacy tokens to migrate\r\n      }\r\n\r\n      // Read legacy tokens\r\n      const legacyTokens = JSON.parse(await fs.readFile(legacyPath, \"utf-8\"));\r\n      \r\n      if (!legacyTokens || typeof legacyTokens !== \"object\") {\r\n        console.error(\"Invalid legacy token format, skipping migration\");\r\n        return false;\r\n      }\r\n\r\n      // Ensure new token directory exists\r\n      await this.ensureTokenDirectoryExists();\r\n      \r\n      // Copy to new location\r\n      await fs.writeFile(this.tokenPath, JSON.stringify(legacyTokens, null, 2), {\r\n        mode: 0o600,\r\n      });\r\n      \r\n      console.error(\"Migrated tokens from legacy location:\", legacyPath, \"to:\", this.tokenPath);\r\n      \r\n      // Optionally remove legacy file after successful migration\r\n      try {\r\n        await fs.unlink(legacyPath);\r\n        console.error(\"Removed legacy token file\");\r\n      } catch (unlinkErr) {\r\n        console.error(\"Warning: Could not remove legacy token file:\", unlinkErr);\r\n      }\r\n      \r\n      return true;\r\n    } catch (error) {\r\n      console.error(\"Error migrating legacy tokens:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async loadSavedTokens(): Promise<boolean> {\r\n    try {\r\n      // Priority 1: Check for tokens in environment variable (for Railway/deployment)\r\n      const envTokens = process.env.GOOGLE_CALENDAR_TOKENS;\r\n      if (envTokens) {\r\n        try {\r\n          const tokens = JSON.parse(envTokens);\r\n          if (tokens && typeof tokens === \"object\") {\r\n            this.oauth2Client.setCredentials(tokens);\r\n            console.log(\"Loaded tokens from environment variable\");\r\n            return true;\r\n          }\r\n        } catch (parseError) {\r\n          console.error(\"Error parsing tokens from environment variable:\", parseError);\r\n          // Fall through to file-based loading\r\n        }\r\n      }\r\n\r\n      // Priority 2: Load from file\r\n      await this.ensureTokenDirectoryExists();\r\n      \r\n      // Check if current token file exists\r\n      const tokenExists = await fs.access(this.tokenPath).then(() => true).catch(() => false);\r\n      \r\n      // If no current tokens, try to migrate from legacy location\r\n      if (!tokenExists) {\r\n        const migrated = await this.migrateLegacyTokens();\r\n        if (!migrated) {\r\n          console.error(\"No token file found at:\", this.tokenPath);\r\n          return false;\r\n        }\r\n      }\r\n\r\n      const tokens = JSON.parse(await fs.readFile(this.tokenPath, \"utf-8\"));\r\n\r\n      if (!tokens || typeof tokens !== \"object\") {\r\n        console.error(\"Invalid token format in file:\", this.tokenPath);\r\n        return false;\r\n      }\r\n\r\n      this.oauth2Client.setCredentials(tokens);\r\n      return true;\r\n    } catch (error: unknown) {\r\n      console.error(\"Error loading tokens:\", error);\r\n      // Attempt to delete potentially corrupted token file\r\n      if (error instanceof Error && 'code' in error && error.code !== 'ENOENT') { \r\n          try { \r\n              await fs.unlink(this.tokenPath); \r\n              console.error(\"Removed potentially corrupted token file\") \r\n            } catch (unlinkErr) { /* ignore */ } \r\n      }\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async refreshTokensIfNeeded(): Promise<boolean> {\r\n    const expiryDate = this.oauth2Client.credentials.expiry_date;\r\n    const isExpired = expiryDate\r\n      ? Date.now() >= expiryDate - 5 * 60 * 1000 // 5 minute buffer\r\n      : !this.oauth2Client.credentials.access_token; // No token means we need one\r\n\r\n    if (isExpired && this.oauth2Client.credentials.refresh_token) {\r\n      console.error(\"Auth token expired or nearing expiry, refreshing...\");\r\n      try {\r\n        const response = await this.oauth2Client.refreshAccessToken();\r\n        const newTokens = response.credentials;\r\n\r\n        if (!newTokens.access_token) {\r\n          throw new Error(\"Received invalid tokens during refresh\");\r\n        }\r\n        // The 'tokens' event listener should handle saving\r\n        this.oauth2Client.setCredentials(newTokens);\r\n        console.error(\"Token refreshed successfully\");\r\n        return true;\r\n      } catch (refreshError) {\r\n        if (refreshError instanceof GaxiosError && refreshError.response?.data?.error === 'invalid_grant') {\r\n            console.error(\"Error refreshing auth token: Invalid grant. Token likely expired or revoked. Please re-authenticate.\");\r\n            // Optionally clear the potentially invalid tokens here\r\n            // await this.clearTokens(); \r\n            return false; // Indicate failure due to invalid grant\r\n        } else {\r\n            // Handle other refresh errors\r\n            console.error(\"Error refreshing auth token:\", refreshError);\r\n            return false;\r\n        }\r\n      }\r\n    } else if (!this.oauth2Client.credentials.access_token && !this.oauth2Client.credentials.refresh_token) {\r\n        console.error(\"No access or refresh token available. Please re-authenticate.\");\r\n        return false;\r\n    } else {\r\n        // Token is valid or no refresh token available\r\n        return true;\r\n    }\r\n  }\r\n\r\n  async validateTokens(): Promise<boolean> {\r\n    if (!this.oauth2Client.credentials || !this.oauth2Client.credentials.access_token) {\r\n        // Try loading first if no credentials set\r\n        if (!(await this.loadSavedTokens())) {\r\n            return false; // No saved tokens to load\r\n        }\r\n        // Check again after loading\r\n        if (!this.oauth2Client.credentials || !this.oauth2Client.credentials.access_token) {\r\n            return false; // Still no token after loading\r\n        }\r\n    }\r\n    return this.refreshTokensIfNeeded();\r\n  }\r\n\r\n  async saveTokens(tokens: Credentials): Promise<void> {\r\n    try {\r\n        await this.ensureTokenDirectoryExists();\r\n        await fs.writeFile(this.tokenPath, JSON.stringify(tokens, null, 2), { mode: 0o600 });\r\n        this.oauth2Client.setCredentials(tokens);\r\n        console.error(\"Tokens saved successfully to:\", this.tokenPath);\r\n    } catch (error: unknown) {\r\n        console.error(\"Error saving tokens:\", error);\r\n        throw error;\r\n    }\r\n  }\r\n\r\n  async clearTokens(): Promise<void> {\r\n    try {\r\n      this.oauth2Client.setCredentials({}); // Clear in memory\r\n      await fs.unlink(this.tokenPath);\r\n      console.error(\"Tokens cleared successfully\");\r\n    } catch (error: unknown) {\r\n      if (error instanceof Error && 'code' in error && error.code === 'ENOENT') {\r\n        // File already gone, which is fine\r\n        console.error(\"Token file already deleted\");\r\n      } else {\r\n        console.error(\"Error clearing tokens:\", error);\r\n        // Don't re-throw, clearing is best-effort\r\n      }\r\n    }\r\n  }\r\n} ", "import { ListToolsRequestSchema } from \"@modelcontextprotocol/sdk/types.js\";\r\n\r\n// Extracted reminder properties definition for reusability\r\nconst remindersInputProperty = {\r\n    type: \"object\",\r\n    description: \"Reminder settings for the event\",\r\n    properties: {\r\n      useDefault: {\r\n        type: \"boolean\",\r\n        description: \"Whether to use the default reminders\",\r\n      },\r\n      overrides: {\r\n        type: \"array\",\r\n        description: \"Custom reminders (uses popup notifications by default unless email is specified)\",\r\n        items: {\r\n          type: \"object\",\r\n          properties: {\r\n            method: {\r\n              type: \"string\",\r\n              enum: [\"email\", \"popup\"],\r\n              description: \"Reminder method (defaults to popup unless email is specified)\",\r\n              default: \"popup\"\r\n            },\r\n            minutes: {\r\n              type: \"number\",\r\n              description: \"Minutes before the event to trigger the reminder\",\r\n            }\r\n          },\r\n          required: [\"minutes\"]\r\n        }\r\n      }\r\n    },\r\n    required: [\"useDefault\"]\r\n};\r\n\r\nexport function getToolDefinitions() {\r\n  return {\r\n    tools: [\r\n      {\r\n        name: \"list-calendars\",\r\n        description: \"List user calendars. Returns: array of calendar objects with id, summary, accessRole, backgroundColor, primary. Use when: showing available calendars or finding calendar ID. Note: 'primary' for main calendar.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {}, // No arguments needed\r\n          required: [],\r\n        },\r\n      },\r\n      {\r\n        name: \"list-events\",\r\n        description: \"List calendar events. Returns: array of event objects with id, summary, start, end, status, recurrence. Use when: viewing schedule, finding events. Note: supports batch (up to 50 calendars).\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            calendarId: {\r\n              oneOf: [\r\n                {\r\n                  type: \"string\",\r\n                  description: \"ID of a single calendar\"\r\n                },\r\n                {\r\n                  type: \"array\",\r\n                  description: \"Array of calendar IDs\",\r\n                  items: {\r\n                    type: \"string\"\r\n                  },\r\n                  minItems: 1,\r\n                  maxItems: 50\r\n                }\r\n              ],\r\n              description: \"ID of the calendar(s) to list events from (use 'primary' for the main calendar)\",\r\n            },\r\n            timeMin: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"Start time in ISO format with timezone required (e.g., 2024-01-01T00:00:00Z or 2024-01-01T00:00:00+00:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n            timeMax: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"End time in ISO format with timezone required (e.g., 2024-12-31T23:59:59Z or 2024-12-31T23:59:59+00:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n          },\r\n          required: [\"calendarId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"search-events\",\r\n        description: \"Search events by text. Returns: filtered array of events matching query in summary/description/location. Use when: finding specific events by keyword. Note: single calendar only.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            calendarId: {\r\n              type: \"string\",\r\n              description: \"ID of the calendar to search events in (use 'primary' for the main calendar)\",\r\n            },\r\n            query: {\r\n              type: \"string\",\r\n              description: \"Free text search query (searches summary, description, location, attendees, etc.)\",\r\n            },\r\n            timeMin: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"Start time boundary in ISO format with timezone required (e.g., 2024-01-01T00:00:00Z or 2024-01-01T00:00:00+00:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n            timeMax: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"End time boundary in ISO format with timezone required (e.g., 2024-12-31T23:59:59Z or 2024-12-31T23:59:59+00:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n          },\r\n          required: [\"calendarId\", \"query\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"list-colors\",\r\n        description: \"Get color palette. Returns: event colors (1-11) and calendar colors with hex values. Use when: displaying color options for event/calendar styling. Note: colorId is string.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {}, // No arguments needed\r\n          required: [],\r\n        },\r\n      },\r\n      {\r\n        name: \"create-event\",\r\n        description: \"Create calendar event. Returns: created event with id, htmlLink, start, end, status. Use when: scheduling new appointments/meetings. Note: supports recurring events via recurrence.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            calendarId: {\r\n              type: \"string\",\r\n              description: \"ID of the calendar to create the event in (use 'primary' for the main calendar)\",\r\n            },\r\n            summary: {\r\n              type: \"string\",\r\n              description: \"Title of the event\",\r\n            },\r\n            description: {\r\n              type: \"string\",\r\n              description: \"Description/notes for the event (optional)\",\r\n            },\r\n            start: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"Start time in ISO format with timezone required (e.g., 2024-08-15T10:00:00Z or 2024-08-15T10:00:00-07:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n            end: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"End time in ISO format with timezone required (e.g., 2024-08-15T11:00:00Z or 2024-08-15T11:00:00-07:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n            timeZone: {\r\n              type: \"string\",\r\n              description:\r\n                \"Timezone of the event start/end times, formatted as an IANA Time Zone Database name (e.g., America/Los_Angeles). Required if start/end times are specified, especially for recurring events.\",\r\n            },\r\n            location: {\r\n              type: \"string\",\r\n              description: \"Location of the event (optional)\",\r\n            },\r\n            attendees: {\r\n              type: \"array\",\r\n              description: \"List of attendee email addresses (optional)\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  email: {\r\n                    type: \"string\",\r\n                    format: \"email\",\r\n                    description: \"Email address of the attendee\",\r\n                  },\r\n                },\r\n                required: [\"email\"],\r\n              },\r\n            },\r\n            colorId: {\r\n              type: \"string\",\r\n              description: \"Color ID for the event (optional, use list-colors to see available IDs)\",\r\n            },\r\n            reminders: remindersInputProperty,\r\n            recurrence: {\r\n              type: \"array\",\r\n              description:\r\n                \"List of recurrence rules (RRULE, EXRULE, RDATE, EXDATE) in RFC5545 format (optional). Example: [\\\"RRULE:FREQ=WEEKLY;COUNT=5\\\"]\",\r\n              items: {\r\n                type: \"string\"\r\n              }\r\n            },\r\n          },\r\n          required: [\"calendarId\", \"summary\", \"start\", \"end\", \"timeZone\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"update-event\",\r\n        description: \"Modify existing event. Returns: updated event with id, summary, start, end. Use when: rescheduling, changing details. Note: supports recurring event scopes (single/all/future).\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            calendarId: {\r\n              type: \"string\",\r\n              description: \"ID of the calendar containing the event\",\r\n            },\r\n            eventId: {\r\n              type: \"string\",\r\n              description: \"ID of the event to update\",\r\n            },\r\n            summary: {\r\n              type: \"string\",\r\n              description: \"New title for the event (optional)\",\r\n            },\r\n            description: {\r\n              type: \"string\",\r\n              description: \"New description for the event (optional)\",\r\n            },\r\n            start: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"New start time in ISO format with timezone required (e.g., 2024-08-15T10:00:00Z or 2024-08-15T10:00:00-07:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n            end: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"New end time in ISO format with timezone required (e.g., 2024-08-15T11:00:00Z or 2024-08-15T11:00:00-07:00). Date-time must end with Z (UTC) or +/-HH:MM offset.\",\r\n            },\r\n            timeZone: {\r\n              type: \"string\",\r\n              description:\r\n                \"Timezone for the start/end times (IANA format, e.g., America/Los_Angeles). Required if modifying start/end, or for recurring events.\",\r\n            },\r\n            location: {\r\n              type: \"string\",\r\n              description: \"New location for the event (optional)\",\r\n            },\r\n            colorId: {\r\n              type: \"string\",\r\n              description: \"New color ID for the event (optional)\",\r\n            },\r\n            attendees: {\r\n              type: \"array\",\r\n              description: \"New list of attendee email addresses (optional, replaces existing attendees)\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  email: {\r\n                    type: \"string\",\r\n                    format: \"email\",\r\n                    description: \"Email address of the attendee\",\r\n                  },\r\n                },\r\n                required: [\"email\"],\r\n              },\r\n            },\r\n            reminders: {\r\n                ...remindersInputProperty,\r\n                description: \"New reminder settings for the event (optional)\",\r\n            },\r\n            recurrence: {\r\n              type: \"array\",\r\n              description:\r\n                \"New list of recurrence rules (RFC5545 format, optional, replaces existing rules). Example: [\\\"RRULE:FREQ=DAILY;COUNT=10\\\"]\",\r\n              items: {\r\n                type: \"string\"\r\n              }\r\n            },\r\n            modificationScope: {\r\n              type: \"string\",\r\n              enum: [\"single\", \"all\", \"future\"],\r\n              default: \"all\",\r\n              description: \"Scope of modification for recurring events: 'single' (one instance), 'all' (entire series), 'future' (this and future instances). Defaults to 'all' for backward compatibility.\"\r\n            },\r\n            originalStartTime: {\r\n              type: \"string\",\r\n              format: \"date-time\",\r\n              description: \"Required when modificationScope is 'single'. Original start time of the specific instance to modify in ISO format with timezone (e.g., 2024-08-15T10:00:00-07:00).\"\r\n            },\r\n            futureStartDate: {\r\n              type: \"string\", \r\n              format: \"date-time\",\r\n              description: \"Required when modificationScope is 'future'. Start date for future modifications in ISO format with timezone (e.g., 2024-08-20T10:00:00-07:00). Must be a future date.\"\r\n            }\r\n          },\r\n          required: [\"calendarId\", \"eventId\", \"timeZone\"], // timeZone is technically required for PATCH\r\n          allOf: [\r\n            {\r\n              if: { \r\n                properties: { \r\n                  modificationScope: { const: \"single\" } \r\n                } \r\n              },\r\n              then: { \r\n                required: [\"originalStartTime\"] \r\n              }\r\n            },\r\n            {\r\n              if: { \r\n                properties: { \r\n                  modificationScope: { const: \"future\" } \r\n                } \r\n              },\r\n              then: { \r\n                required: [\"futureStartDate\"] \r\n              }\r\n            }\r\n          ]\r\n        },\r\n      },\r\n      {\r\n        name: \"delete-event\",\r\n        description: \"Remove event from calendar. Returns: empty on success. Use when: canceling appointments. Note: permanent deletion, not recoverable.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            calendarId: {\r\n              type: \"string\",\r\n              description: \"ID of the calendar containing the event\",\r\n            },\r\n            eventId: {\r\n              type: \"string\",\r\n              description: \"ID of the event to delete\",\r\n            },\r\n          },\r\n          required: [\"calendarId\", \"eventId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"get-freebusy\",\r\n        description: \"Check calendar availability. Returns: busy time blocks per calendar. Use when: finding available slots, scheduling across calendars. Note: only shows busy/free, not event details.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            timeMin: {\r\n              type: \"string\",\r\n              description: \"The start of the interval in RFC3339 format\",\r\n            },\r\n            timeMax: {\r\n              type: \"string\",\r\n              description: \"The end of the interval in RFC3339 format\",\r\n            },\r\n            timeZone: {\r\n              type: \"string\",\r\n              description: \"Optional. Time zone used in the response (default is UTC)\",\r\n            },\r\n            groupExpansionMax: {\r\n              type: \"integer\",\r\n              description: \"Optional. Maximum number of calendar identifiers to expand per group (max 100)\",\r\n            },\r\n            calendarExpansionMax: {\r\n              type: \"integer\",\r\n              description: \"Optional. Maximum number of calendars to expand (max 50)\",\r\n            },\r\n            items: {\r\n              type: \"array\",\r\n              description: \"List of calendar or group identifiers to check for availability\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  id: {\r\n                    type: \"string\",\r\n                    description: \"The identifier of a calendar or group, it usually is a mail format\",\r\n                  },\r\n                },\r\n                required: [\"id\"],\r\n              },\r\n            },\r\n          },\r\n          required: [\"timeMin\", \"timeMax\", \"items\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"list-contacts\",\r\n        description: \"List Google Contacts. Returns: array with resourceName, names, emailAddresses, phoneNumbers per contact. Use when: viewing contact list, searching by name. Note: use personFields to limit data.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            pageSize: {\r\n              type: \"number\",\r\n              description: \"Maximum number of contacts to return (default: 100, max: 2000)\",\r\n            },\r\n            pageToken: {\r\n              type: \"string\",\r\n              description: \"Token for pagination to get the next page of results\",\r\n            },\r\n            query: {\r\n              type: \"string\",\r\n              description: \"Optional search query to filter contacts\",\r\n            },\r\n            personFields: {\r\n              type: \"array\",\r\n              description: \"Fields to include in the response (default: names,emailAddresses,phoneNumbers,addresses,organizations,biographies,photos)\",\r\n              items: {\r\n                type: \"string\",\r\n                enum: [\"addresses\", \"ageRanges\", \"biographies\", \"birthdays\", \"calendarUrls\", \"clientData\", \"coverPhotos\", \"emailAddresses\", \"events\", \"externalIds\", \"genders\", \"imClients\", \"interests\", \"locales\", \"locations\", \"memberships\", \"metadata\", \"miscKeywords\", \"names\", \"nicknames\", \"occupations\", \"organizations\", \"phoneNumbers\", \"photos\", \"relations\", \"sipAddresses\", \"skills\", \"urls\", \"userDefined\"]\r\n              }\r\n            },\r\n            sources: {\r\n              type: \"array\",\r\n              description: \"Sources to get contacts from (default: READ_SOURCE_TYPE_CONTACT)\",\r\n              items: {\r\n                type: \"string\",\r\n                enum: [\"READ_SOURCE_TYPE_CONTACT\", \"READ_SOURCE_TYPE_PROFILE\", \"READ_SOURCE_TYPE_DOMAIN_PROFILE\", \"READ_SOURCE_TYPE_OTHER_CONTACT\"]\r\n              }\r\n            }\r\n          },\r\n          required: [],\r\n        },\r\n      },\r\n      {\r\n        name: \"get-contact\",\r\n        description: \"Retrieve one contact by resourceName. Returns: full contact with all requested fields. Use when: viewing detailed contact info. Note: resourceName format is 'people/c[ID]'.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            resourceName: {\r\n              type: \"string\",\r\n              description: \"Resource name of the contact (e.g., 'people/c1234567890')\",\r\n            },\r\n            personFields: {\r\n              type: \"array\",\r\n              description: \"Fields to include in the response\",\r\n              items: {\r\n                type: \"string\",\r\n                enum: [\"addresses\", \"ageRanges\", \"biographies\", \"birthdays\", \"calendarUrls\", \"clientData\", \"coverPhotos\", \"emailAddresses\", \"events\", \"externalIds\", \"genders\", \"imClients\", \"interests\", \"locales\", \"locations\", \"memberships\", \"metadata\", \"miscKeywords\", \"names\", \"nicknames\", \"occupations\", \"organizations\", \"phoneNumbers\", \"photos\", \"relations\", \"sipAddresses\", \"skills\", \"urls\", \"userDefined\"]\r\n              }\r\n            }\r\n          },\r\n          required: [\"resourceName\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"create-contact\",\r\n        description: \"Create new contact. Returns: created contact with resourceName, etag, metadata. Use when: adding new person to contacts. Note: returns new resourceName for future operations.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            givenName: {\r\n              type: \"string\",\r\n              description: \"First name of the contact\",\r\n            },\r\n            familyName: {\r\n              type: \"string\",\r\n              description: \"Last name of the contact\",\r\n            },\r\n            middleName: {\r\n              type: \"string\",\r\n              description: \"Middle name of the contact\",\r\n            },\r\n            displayName: {\r\n              type: \"string\",\r\n              description: \"Display name (defaults to 'givenName familyName' if not provided)\",\r\n            },\r\n            emailAddresses: {\r\n              type: \"array\",\r\n              description: \"Email addresses for the contact\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  value: {\r\n                    type: \"string\",\r\n                    format: \"email\",\r\n                    description: \"Email address\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"home\", \"work\", \"other\"],\r\n                    description: \"Type of email address (default: home)\",\r\n                  },\r\n                },\r\n                required: [\"value\"],\r\n              },\r\n            },\r\n            phoneNumbers: {\r\n              type: \"array\",\r\n              description: \"Phone numbers for the contact\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  value: {\r\n                    type: \"string\",\r\n                    description: \"Phone number\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"home\", \"work\", \"mobile\", \"homeFax\", \"workFax\", \"otherFax\", \"pager\", \"workMobile\", \"workPager\", \"main\", \"googleVoice\", \"other\"],\r\n                    description: \"Type of phone number (default: home)\",\r\n                  },\r\n                },\r\n                required: [\"value\"],\r\n              },\r\n            },\r\n            addresses: {\r\n              type: \"array\",\r\n              description: \"Physical addresses for the contact\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  streetAddress: {\r\n                    type: \"string\",\r\n                    description: \"Street address\",\r\n                  },\r\n                  city: {\r\n                    type: \"string\",\r\n                    description: \"City\",\r\n                  },\r\n                  region: {\r\n                    type: \"string\",\r\n                    description: \"State or region\",\r\n                  },\r\n                  postalCode: {\r\n                    type: \"string\",\r\n                    description: \"Postal or ZIP code\",\r\n                  },\r\n                  country: {\r\n                    type: \"string\",\r\n                    description: \"Country\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"home\", \"work\", \"other\"],\r\n                    description: \"Type of address (default: home)\",\r\n                  },\r\n                },\r\n              },\r\n            },\r\n            organizations: {\r\n              type: \"array\",\r\n              description: \"Organizations/companies for the contact\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  name: {\r\n                    type: \"string\",\r\n                    description: \"Organization name\",\r\n                  },\r\n                  title: {\r\n                    type: \"string\",\r\n                    description: \"Job title\",\r\n                  },\r\n                  department: {\r\n                    type: \"string\",\r\n                    description: \"Department\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"work\", \"school\", \"other\"],\r\n                    description: \"Type of organization (default: work)\",\r\n                  },\r\n                },\r\n              },\r\n            },\r\n            biographies: {\r\n              type: \"array\",\r\n              description: \"Biographical information\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  value: {\r\n                    type: \"string\",\r\n                    description: \"Biography text\",\r\n                  },\r\n                  contentType: {\r\n                    type: \"string\",\r\n                    enum: [\"TEXT_PLAIN\", \"TEXT_HTML\"],\r\n                    description: \"Content type (default: TEXT_PLAIN)\",\r\n                  },\r\n                },\r\n                required: [\"value\"],\r\n              },\r\n            },\r\n            notes: {\r\n              type: \"string\",\r\n              description: \"Notes about the contact (will be added as a biography if biographies not provided)\",\r\n            },\r\n          },\r\n          required: [],\r\n        },\r\n      },\r\n      {\r\n        name: \"update-contact\",\r\n        description: \"Modify existing contact. Returns: updated contact with new etag. Use when: changing contact details. Note: requires updatePersonFields to specify what to update.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            resourceName: {\r\n              type: \"string\",\r\n              description: \"Resource name of the contact to update (e.g., 'people/c1234567890')\",\r\n            },\r\n            updatePersonFields: {\r\n              type: \"array\",\r\n              description: \"Fields to update (must specify which fields are being updated)\",\r\n              items: {\r\n                type: \"string\",\r\n                enum: [\"names\", \"emailAddresses\", \"phoneNumbers\", \"addresses\", \"organizations\", \"biographies\"]\r\n              }\r\n            },\r\n            givenName: {\r\n              type: \"string\",\r\n              description: \"First name (required if updating names)\",\r\n            },\r\n            familyName: {\r\n              type: \"string\",\r\n              description: \"Last name (required if updating names)\",\r\n            },\r\n            middleName: {\r\n              type: \"string\",\r\n              description: \"Middle name\",\r\n            },\r\n            displayName: {\r\n              type: \"string\",\r\n              description: \"Display name\",\r\n            },\r\n            emailAddresses: {\r\n              type: \"array\",\r\n              description: \"Email addresses (replaces all existing if updating)\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  value: {\r\n                    type: \"string\",\r\n                    format: \"email\",\r\n                    description: \"Email address\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"home\", \"work\", \"other\"],\r\n                    description: \"Type of email address\",\r\n                  },\r\n                },\r\n                required: [\"value\"],\r\n              },\r\n            },\r\n            phoneNumbers: {\r\n              type: \"array\",\r\n              description: \"Phone numbers (replaces all existing if updating)\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  value: {\r\n                    type: \"string\",\r\n                    description: \"Phone number\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"home\", \"work\", \"mobile\", \"homeFax\", \"workFax\", \"otherFax\", \"pager\", \"workMobile\", \"workPager\", \"main\", \"googleVoice\", \"other\"],\r\n                    description: \"Type of phone number\",\r\n                  },\r\n                },\r\n                required: [\"value\"],\r\n              },\r\n            },\r\n            addresses: {\r\n              type: \"array\",\r\n              description: \"Physical addresses (replaces all existing if updating)\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  streetAddress: {\r\n                    type: \"string\",\r\n                    description: \"Street address\",\r\n                  },\r\n                  city: {\r\n                    type: \"string\",\r\n                    description: \"City\",\r\n                  },\r\n                  region: {\r\n                    type: \"string\",\r\n                    description: \"State or region\",\r\n                  },\r\n                  postalCode: {\r\n                    type: \"string\",\r\n                    description: \"Postal or ZIP code\",\r\n                  },\r\n                  country: {\r\n                    type: \"string\",\r\n                    description: \"Country\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"home\", \"work\", \"other\"],\r\n                    description: \"Type of address\",\r\n                  },\r\n                },\r\n              },\r\n            },\r\n            organizations: {\r\n              type: \"array\",\r\n              description: \"Organizations (replaces all existing if updating)\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  name: {\r\n                    type: \"string\",\r\n                    description: \"Organization name\",\r\n                  },\r\n                  title: {\r\n                    type: \"string\",\r\n                    description: \"Job title\",\r\n                  },\r\n                  department: {\r\n                    type: \"string\",\r\n                    description: \"Department\",\r\n                  },\r\n                  type: {\r\n                    type: \"string\",\r\n                    enum: [\"work\", \"school\", \"other\"],\r\n                    description: \"Type of organization\",\r\n                  },\r\n                },\r\n              },\r\n            },\r\n            biographies: {\r\n              type: \"array\",\r\n              description: \"Biographical information (replaces all existing if updating)\",\r\n              items: {\r\n                type: \"object\",\r\n                properties: {\r\n                  value: {\r\n                    type: \"string\",\r\n                    description: \"Biography text\",\r\n                  },\r\n                  contentType: {\r\n                    type: \"string\",\r\n                    enum: [\"TEXT_PLAIN\", \"TEXT_HTML\"],\r\n                    description: \"Content type\",\r\n                  },\r\n                },\r\n                required: [\"value\"],\r\n              },\r\n            },\r\n          },\r\n          required: [\"resourceName\", \"updatePersonFields\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"delete-contact\",\r\n        description: \"Remove contact permanently. Returns: empty on success. Use when: deleting person from contacts. Note: permanent deletion, use resourceName from list/get.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            resourceName: {\r\n              type: \"string\",\r\n              description: \"Resource name of the contact to delete (e.g., 'people/c1234567890')\",\r\n            },\r\n          },\r\n          required: [\"resourceName\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"list-emails\",\r\n        description: \"Search emails in Gmail. Returns: array with id, threadId only (no content/labels). Use when: finding emails to get IDs for other operations. Note: retrieve full content with get-email per ID.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            query: {\r\n              type: \"string\",\r\n              description: \"Gmail search operators: 'from:email@domain.com', 'to:email', 'subject:text', 'is:unread', 'is:read', 'is:starred', 'is:important', 'has:attachment', 'in:inbox', 'in:sent', 'after:2024/1/1', 'before:2024/12/31', 'larger:1M', 'smaller:5M'. Combine with spaces for AND, OR for alternatives.\",\r\n            },\r\n            maxResults: {\r\n              type: \"number\",\r\n              description: \"Maximum number of emails to return (default: 20, max: 500)\",\r\n            },\r\n            pageToken: {\r\n              type: \"string\",\r\n              description: \"Token for pagination to get the next page of results\",\r\n            },\r\n            includeSpamTrash: {\r\n              type: \"boolean\",\r\n              description: \"Include emails from SPAM and TRASH (default: false)\",\r\n            },\r\n            labelIds: {\r\n              type: \"array\",\r\n              description: \"Filter by specific label IDs\",\r\n              items: {\r\n                type: \"string\"\r\n              }\r\n            }\r\n          },\r\n          required: [],\r\n        },\r\n      },\r\n      {\r\n        name: \"get-email\",\r\n        description: \"Retrieve one email by messageId. Returns: full message with headers, body (plain/html), attachments metadata. Use when: reading email content after list-emails. Note: messageId from list-emails required.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            messageId: {\r\n              type: \"string\",\r\n              description: \"The ID of the email message to retrieve\",\r\n            },\r\n            markAsRead: {\r\n              type: \"boolean\",\r\n              description: \"Mark the email as read when retrieving (default: true)\",\r\n            },\r\n            format: {\r\n              type: \"string\",\r\n              enum: [\"full\", \"metadata\", \"minimal\"],\r\n              description: \"The format to return the message in (default: full)\",\r\n            }\r\n          },\r\n          required: [\"messageId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"send-email\",\r\n        description: \"Send new email or reply. Returns: sent message id and threadId. Use when: composing new email or replying to thread. For replies: provide replyToMessageId.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            to: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"Recipient email address(es)\",\r\n            },\r\n            subject: {\r\n              type: \"string\",\r\n              description: \"Email subject line\",\r\n            },\r\n            body: {\r\n              type: \"string\",\r\n              description: \"Email body content\",\r\n            },\r\n            cc: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"CC recipient email address(es)\",\r\n            },\r\n            bcc: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"BCC recipient email address(es)\",\r\n            },\r\n            isHtml: {\r\n              type: \"boolean\",\r\n              description: \"Whether the body is HTML content (default: false)\",\r\n            },\r\n            replyToMessageId: {\r\n              type: \"string\",\r\n              description: \"Message ID to reply to (for threading)\",\r\n            },\r\n            threadId: {\r\n              type: \"string\",\r\n              description: \"Thread ID to reply within\",\r\n            }\r\n          },\r\n          required: [\"to\", \"subject\", \"body\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"update-email\",\r\n        description: \"Modify single email labels/status. Returns: updated message with new labelIds. Use when: marking one email read/unread/starred. For multiple: use batch-update-emails. Labels: UNREAD, STARRED, IMPORTANT, INBOX.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            messageId: {\r\n              type: \"string\",\r\n              description: \"Message ID from list-emails or get-email response (not email address)\",\r\n            },\r\n            addLabelIds: {\r\n              type: \"array\",\r\n              description: \"System labels to add: UNREAD, STARRED, IMPORTANT, INBOX, SPAM, TRASH, or custom label IDs\",\r\n              items: { type: \"string\" }\r\n            },\r\n            removeLabelIds: {\r\n              type: \"array\",\r\n              description: \"System labels to remove: UNREAD, STARRED, IMPORTANT, INBOX (can't remove DRAFTS, SENT)\",\r\n              items: { type: \"string\" }\r\n            },\r\n            markAsRead: {\r\n              type: \"boolean\",\r\n              description: \"Remove UNREAD label (shortcut for removeLabelIds: ['UNREAD'])\",\r\n            },\r\n            markAsUnread: {\r\n              type: \"boolean\",\r\n              description: \"Add UNREAD label (shortcut for addLabelIds: ['UNREAD'])\",\r\n            },\r\n            star: {\r\n              type: \"boolean\",\r\n              description: \"Star the email\",\r\n            },\r\n            unstar: {\r\n              type: \"boolean\",\r\n              description: \"Unstar the email\",\r\n            },\r\n            markAsImportant: {\r\n              type: \"boolean\",\r\n              description: \"Mark as important\",\r\n            },\r\n            markAsNotImportant: {\r\n              type: \"boolean\",\r\n              description: \"Mark as not important\",\r\n            },\r\n            archive: {\r\n              type: \"boolean\",\r\n              description: \"Archive the email (remove from inbox)\",\r\n            },\r\n            unarchive: {\r\n              type: \"boolean\",\r\n              description: \"Unarchive the email (add to inbox)\",\r\n            },\r\n            moveToTrash: {\r\n              type: \"boolean\",\r\n              description: \"Move to trash\",\r\n            },\r\n            removeFromTrash: {\r\n              type: \"boolean\",\r\n              description: \"Remove from trash\",\r\n            }\r\n          },\r\n          required: [\"messageId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"delete-email\",\r\n        description: \"Move email to trash or delete permanently. Returns: success status. Use when: removing emails. Default: trash (recoverable). Set permanent=true for unrecoverable deletion.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            messageId: {\r\n              type: \"string\",\r\n              description: \"Message ID from list-emails or get-email response\",\r\n            },\r\n            permanent: {\r\n              type: \"boolean\",\r\n              description: \"Permanently delete instead of moving to trash (default: false)\",\r\n            }\r\n          },\r\n          required: [\"messageId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"create-draft\",\r\n        description: \"Create unsent email draft. Returns: draft id and message. Use when: composing email for later editing/sending. Not for immediate send - use send-email instead.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            to: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"Recipient email address(es)\",\r\n            },\r\n            subject: {\r\n              type: \"string\",\r\n              description: \"Email subject line\",\r\n            },\r\n            body: {\r\n              type: \"string\",\r\n              description: \"Email body content\",\r\n            },\r\n            cc: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"CC recipient email address(es)\",\r\n            },\r\n            bcc: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"BCC recipient email address(es)\",\r\n            },\r\n            isHtml: {\r\n              type: \"boolean\",\r\n              description: \"Whether the body is HTML content (default: false)\",\r\n            },\r\n            replyToMessageId: {\r\n              type: \"string\",\r\n              description: \"Message ID to reply to (for threading)\",\r\n            },\r\n            threadId: {\r\n              type: \"string\",\r\n              description: \"Thread ID to reply within\",\r\n            }\r\n          },\r\n          required: [\"to\", \"subject\", \"body\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"update-draft\",\r\n        description: \"Modify existing draft. Returns: updated draft with id, message. Use when: editing unsent draft content. Note: replaces entire draft content.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            draftId: {\r\n              type: \"string\",\r\n              description: \"The ID of the draft to update\",\r\n            },\r\n            to: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"Recipient email address(es)\",\r\n            },\r\n            subject: {\r\n              type: \"string\",\r\n              description: \"Email subject line\",\r\n            },\r\n            body: {\r\n              type: \"string\",\r\n              description: \"Email body content\",\r\n            },\r\n            cc: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"CC recipient email address(es)\",\r\n            },\r\n            bcc: {\r\n              oneOf: [\r\n                { type: \"string\", format: \"email\" },\r\n                { type: \"array\", items: { type: \"string\", format: \"email\" } }\r\n              ],\r\n              description: \"BCC recipient email address(es)\",\r\n            },\r\n            isHtml: {\r\n              type: \"boolean\",\r\n              description: \"Whether the body is HTML content (default: false)\",\r\n            },\r\n            replyToMessageId: {\r\n              type: \"string\",\r\n              description: \"Message ID to reply to (for threading)\",\r\n            },\r\n            threadId: {\r\n              type: \"string\",\r\n              description: \"Thread ID to reply within\",\r\n            }\r\n          },\r\n          required: [\"draftId\", \"to\", \"subject\", \"body\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"send-draft\",\r\n        description: \"Send saved draft. Returns: sent message with id, threadId, labelIds. Use when: sending previously created draft. Note: draft is deleted after sending.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            draftId: {\r\n              type: \"string\",\r\n              description: \"The ID of the draft to send\",\r\n            }\r\n          },\r\n          required: [\"draftId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"list-labels\",\r\n        description: \"List Gmail labels. Returns: array with id, name, type (system/user). Use when: showing folder structure, finding label IDs. Note: includes system labels like INBOX, SENT.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {},\r\n          required: [],\r\n        },\r\n      },\r\n      {\r\n        name: \"create-label\",\r\n        description: \"Create custom label. Returns: new label with id, name, type='user'. Use when: organizing emails with new categories. Note: can't create system labels.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            name: {\r\n              type: \"string\",\r\n              description: \"Name of the label\",\r\n            },\r\n            messageListVisibility: {\r\n              type: \"string\",\r\n              enum: [\"show\", \"hide\"],\r\n              description: \"Whether to show messages with this label in message lists (default: show)\",\r\n            },\r\n            labelListVisibility: {\r\n              type: \"string\",\r\n              enum: [\"labelShow\", \"labelShowIfUnread\", \"labelHide\"],\r\n              description: \"Whether to show this label in the label list (default: labelShow)\",\r\n            },\r\n            backgroundColor: {\r\n              type: \"string\",\r\n              description: \"Background color for the label (hex color like '#0000FF')\",\r\n            },\r\n            textColor: {\r\n              type: \"string\",\r\n              description: \"Text color for the label (hex color like '#FFFFFF')\",\r\n            }\r\n          },\r\n          required: [\"name\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"update-label\",\r\n        description: \"Modify label properties. Returns: updated label. Use when: renaming labels, changing visibility. Note: can't modify system labels.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            labelId: {\r\n              type: \"string\",\r\n              description: \"The ID of the label to update\",\r\n            },\r\n            name: {\r\n              type: \"string\",\r\n              description: \"New name for the label\",\r\n            },\r\n            messageListVisibility: {\r\n              type: \"string\",\r\n              enum: [\"show\", \"hide\"],\r\n              description: \"Whether to show messages with this label in message lists\",\r\n            },\r\n            labelListVisibility: {\r\n              type: \"string\",\r\n              enum: [\"labelShow\", \"labelShowIfUnread\", \"labelHide\"],\r\n              description: \"Whether to show this label in the label list\",\r\n            },\r\n            backgroundColor: {\r\n              type: \"string\",\r\n              description: \"Background color for the label (hex color)\",\r\n            },\r\n            textColor: {\r\n              type: \"string\",\r\n              description: \"Text color for the label (hex color)\",\r\n            }\r\n          },\r\n          required: [\"labelId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"delete-label\",\r\n        description: \"Remove custom label. Returns: empty on success. Use when: cleaning up unused labels. Note: can't delete system labels, emails keep label reference.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            labelId: {\r\n              type: \"string\",\r\n              description: \"The ID of the label to delete\",\r\n            }\r\n          },\r\n          required: [\"labelId\"],\r\n        },\r\n      },\r\n      {\r\n        name: \"batch-update-emails\",\r\n        description: \"Modify multiple emails labels/status. Returns: empty on success (no response body). Use when: bulk operations on many emails. Limit: 1000 IDs per request. For single: use update-email.\",\r\n        inputSchema: {\r\n          type: \"object\",\r\n          properties: {\r\n            messageIds: {\r\n              type: \"array\",\r\n              description: \"Array of message IDs from list-emails (not email addresses). Maximum 1000 IDs.\",\r\n              items: { type: \"string\" },\r\n              minItems: 1,\r\n              maxItems: 1000\r\n            },\r\n            addLabelIds: {\r\n              type: \"array\",\r\n              description: \"System labels: UNREAD, STARRED, IMPORTANT, INBOX, SPAM, TRASH (can't add DRAFTS, SENT)\",\r\n              items: { type: \"string\" }\r\n            },\r\n            removeLabelIds: {\r\n              type: \"array\",\r\n              description: \"System labels: UNREAD, STARRED, IMPORTANT, INBOX (can't remove DRAFTS, SENT)\",\r\n              items: { type: \"string\" }\r\n            },\r\n            markAsRead: {\r\n              type: \"boolean\",\r\n              description: \"Mark all emails as read\",\r\n            },\r\n            markAsUnread: {\r\n              type: \"boolean\",\r\n              description: \"Mark all emails as unread\",\r\n            },\r\n            star: {\r\n              type: \"boolean\",\r\n              description: \"Star all emails\",\r\n            },\r\n            unstar: {\r\n              type: \"boolean\",\r\n              description: \"Unstar all emails\",\r\n            },\r\n            markAsImportant: {\r\n              type: \"boolean\",\r\n              description: \"Mark all as important\",\r\n            },\r\n            markAsNotImportant: {\r\n              type: \"boolean\",\r\n              description: \"Mark all as not important\",\r\n            },\r\n            archive: {\r\n              type: \"boolean\",\r\n              description: \"Archive all emails\",\r\n            },\r\n            unarchive: {\r\n              type: \"boolean\",\r\n              description: \"Unarchive all emails\",\r\n            },\r\n            moveToTrash: {\r\n              type: \"boolean\",\r\n              description: \"Move all to trash\",\r\n            }\r\n          },\r\n          required: [\"messageIds\"],\r\n        },\r\n      }\r\n    ],\r\n  };\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { GaxiosError } from 'gaxios';\r\nimport { calendar_v3, google } from \"googleapis\";\r\n\r\n\r\nexport abstract class BaseToolHandler {\r\n    abstract runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult>;\r\n\r\n    protected handleGoogleApiError(error: unknown): void {\r\n        if (\r\n            error instanceof GaxiosError &&\r\n            error.response?.data?.error === 'invalid_grant'\r\n        ) {\r\n            throw new Error(\r\n                'Google API Error: Authentication token is invalid or expired. Please re-run the authentication process (e.g., `npm run auth`).'\r\n            );\r\n        }\r\n        throw error;\r\n    }\r\n\r\n    protected getCalendar(auth: OAuth2Client): calendar_v3.Calendar {\r\n        return google.calendar({ version: 'v3', auth });\r\n    }\r\n}\r\n", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { BaseToolHandler } from \"./BaseToolHandler.js\";\r\nimport { calendar_v3, google } from \"googleapis\";\r\n\r\nexport class ListCalendarsHandler extends BaseToolHandler {\r\n    async runTool(_: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n        const calendars = await this.listCalendars(oauth2Client);\r\n        return {\r\n            content: [{\r\n                type: \"text\", // This MUST be a string literal\r\n                text: this.formatCalendarList(calendars),\r\n            }],\r\n        };\r\n    }\r\n\r\n    private async listCalendars(client: OAuth2Client): Promise<calendar_v3.Schema$CalendarListEntry[]> {\r\n        try {\r\n            const calendar = this.getCalendar(client);\r\n            const response = await calendar.calendarList.list();\r\n            return response.data.items || [];\r\n        } catch (error) {\r\n            throw this.handleGoogleApiError(error);\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * Formats a list of calendars into a user-friendly string.\r\n     */\r\n    private formatCalendarList(calendars: calendar_v3.Schema$CalendarListEntry[]): string {\r\n        return calendars\r\n            .map((cal) => `${cal.summary || \"Untitled\"} (${cal.id || \"no-id\"})`)\r\n            .join(\"\\n\");\r\n    }\r\n\r\n}\r\n", "import { z } from 'zod';\r\n\r\n// Zod schemas for input validation\r\n\r\nexport const ReminderSchema = z.object({\r\n  method: z.enum(['email', 'popup']).default('popup'),\r\n  minutes: z.number(),\r\n});\r\n\r\nexport const RemindersSchema = z.object({\r\n  useDefault: z.boolean(),\r\n  overrides: z.array(ReminderSchema).optional(),\r\n});\r\n\r\n// ISO datetime regex that requires timezone designator (Z or +/-HH:MM)\r\n// Supports optional milliseconds (e.g., .123) for compatibility with Date.toISOString()\r\nconst isoDateTimeWithTimezone = /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?(Z|[+-]\\d{2}:\\d{2})$/;\r\n\r\nexport const ListEventsArgumentsSchema = z.object({\r\n  calendarId: z.preprocess(\r\n    (val) => {\r\n      // If it's a string that looks like JSON array, try to parse it\r\n      if (typeof val === 'string' && val.startsWith('[') && val.endsWith(']')) {\r\n        try {\r\n          return JSON.parse(val);\r\n        } catch {\r\n          // If parsing fails, return as-is (will be validated as string)\r\n          return val;\r\n        }\r\n      }\r\n      return val;\r\n    },\r\n    z.union([\r\n      z.string().min(1, \"Calendar ID cannot be empty\"),\r\n      z.array(z.string().min(1, \"Calendar ID cannot be empty\"))\r\n        .min(1, \"At least one calendar ID is required\")\r\n        .max(50, \"Maximum 50 calendars allowed per request\")\r\n        .refine(\r\n          (ids) => new Set(ids).size === ids.length,\r\n          \"Duplicate calendar IDs are not allowed\"\r\n        )\r\n    ])\r\n  ).describe(\"Calendar ID(s) to fetch events from\"),\r\n  timeMin: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\")\r\n    .optional()\r\n    .describe(\"Start time for event filtering\"),\r\n  timeMax: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\")\r\n    .optional()\r\n    .describe(\"End time for event filtering\"),\r\n}).refine(\r\n  (data) => {\r\n    if (data.timeMin && data.timeMax) {\r\n      return new Date(data.timeMin) < new Date(data.timeMax);\r\n    }\r\n    return true;\r\n  },\r\n  {\r\n    message: \"timeMin must be before timeMax\",\r\n    path: [\"timeMax\"]\r\n  }\r\n);\r\n\r\nexport const SearchEventsArgumentsSchema = z.object({\r\n  calendarId: z.string(),\r\n  query: z.string(),\r\n  timeMin: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\")\r\n    .optional(),\r\n  timeMax: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-12-31T23:59:59Z)\")\r\n    .optional(),\r\n});\r\n\r\nexport const CreateEventArgumentsSchema = z.object({\r\n  calendarId: z.string(),\r\n  summary: z.string(),\r\n  description: z.string().optional(),\r\n  start: z.string().regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\"),\r\n  end: z.string().regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\"),\r\n  timeZone: z.string(),\r\n  attendees: z\r\n    .array(\r\n      z.object({\r\n        email: z.string(),\r\n      })\r\n    )\r\n    .optional(),\r\n  location: z.string().optional(),\r\n  colorId: z.string().optional(),\r\n  reminders: RemindersSchema.optional(),\r\n  recurrence: z.array(z.string()).optional(),\r\n});\r\n\r\nexport const UpdateEventArgumentsSchema = z.object({\r\n  calendarId: z.string(),\r\n  eventId: z.string(),\r\n  summary: z.string().optional(),\r\n  description: z.string().optional(),\r\n  start: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\")\r\n    .optional(),\r\n  end: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\")\r\n    .optional(),\r\n  timeZone: z.string(), // Required even if start/end don't change, per API docs for patch\r\n  attendees: z\r\n    .array(\r\n      z.object({\r\n        email: z.string(),\r\n      })\r\n    )\r\n    .optional(),\r\n  location: z.string().optional(),\r\n  colorId: z.string().optional(),\r\n  reminders: RemindersSchema.optional(),\r\n  recurrence: z.array(z.string()).optional(),\r\n  // New recurring event parameters\r\n  modificationScope: z.enum(['single', 'all', 'future']).default('all'),\r\n  originalStartTime: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\")\r\n    .optional(),\r\n  futureStartDate: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\")\r\n    .optional(),\r\n}).refine(\r\n  (data) => {\r\n    // Require originalStartTime when modificationScope is 'single'\r\n    if (data.modificationScope === 'single' && !data.originalStartTime) {\r\n      return false;\r\n    }\r\n    return true;\r\n  },\r\n  {\r\n    message: \"originalStartTime is required when modificationScope is 'single'\",\r\n    path: [\"originalStartTime\"]\r\n  }\r\n).refine(\r\n  (data) => {\r\n    // Require futureStartDate when modificationScope is 'future'\r\n    if (data.modificationScope === 'future' && !data.futureStartDate) {\r\n      return false;\r\n    }\r\n    return true;\r\n  },\r\n  {\r\n    message: \"futureStartDate is required when modificationScope is 'future'\",\r\n    path: [\"futureStartDate\"]\r\n  }\r\n).refine(\r\n  (data) => {\r\n    // Ensure futureStartDate is in the future when provided\r\n    if (data.futureStartDate) {\r\n      const futureDate = new Date(data.futureStartDate);\r\n      const now = new Date();\r\n      return futureDate > now;\r\n    }\r\n    return true;\r\n  },\r\n  {\r\n    message: \"futureStartDate must be in the future\",\r\n    path: [\"futureStartDate\"]\r\n  }\r\n);\r\n\r\nexport const DeleteEventArgumentsSchema = z.object({\r\n  calendarId: z.string(),\r\n  eventId: z.string(),\r\n});\r\n\r\nexport const FreeBusyEventArgumentsSchema = z.object({\r\n  timeMin: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\"),\r\n  timeMax: z.string()\r\n    .regex(isoDateTimeWithTimezone, \"Must be ISO format with timezone (e.g., 2024-01-01T00:00:00Z)\"),\r\n  timeZone: z.string().optional(),\r\n  groupExpansionMax: z.number().int().max(100).optional(),\r\n  calendarExpansionMax: z.number().int().max(50).optional(),\r\n  items: z.array(z.object({\r\n    id: z.string().email(\"Must be a valid email address\"),\r\n  })),\r\n});", "import { calendar_v3 } from \"googleapis\";\r\n\r\n/**\r\n * Formats a list of events into a user-friendly string.\r\n */\r\nexport function formatEventList(events: calendar_v3.Schema$Event[]): string {\r\n    return events\r\n        .map((event) => {\r\n            const attendeeList = event.attendees\r\n                ? `\\nAttendees: ${event.attendees\r\n                    .map((a) => `${a.email || \"no-email\"} (${a.responseStatus || \"unknown\"})`)\r\n                    .join(\", \")}`\r\n                : \"\";\r\n            const locationInfo = event.location ? `\\nLocation: ${event.location}` : \"\";\r\n            const descriptionInfo = event.description ? `\\nDescription: ${event.description}` : \"\";\r\n            const colorInfo = event.colorId ? `\\nColor ID: ${event.colorId}` : \"\";\r\n            const reminderInfo = event.reminders\r\n                ? `\\nReminders: ${event.reminders.useDefault ? 'Using default' :\r\n                    (event.reminders.overrides || []).map((r: any) => `${r.method} ${r.minutes} minutes before`).join(', ') || 'None'}`\r\n                : \"\";\r\n            return `${event.summary || \"Untitled\"} (${event.id || \"no-id\"})${locationInfo}${descriptionInfo}\\nStart: ${event.start?.dateTime || event.start?.date || \"unspecified\"}\\nEnd: ${event.end?.dateTime || event.end?.date || \"unspecified\"}${attendeeList}${colorInfo}${reminderInfo}\\n`;\r\n        })\r\n        .join(\"\\n\");\r\n}\r\n", "import { OAuth2Client } from \"google-auth-library\";\r\n\r\nexport interface BatchRequest {\r\n  method: string;\r\n  path: string;\r\n  headers?: Record<string, string>;\r\n  body?: any;\r\n}\r\n\r\nexport interface BatchResponse {\r\n  statusCode: number;\r\n  headers: Record<string, string>;\r\n  body: any;\r\n  error?: any;\r\n}\r\n\r\nexport interface BatchError {\r\n  calendarId?: string;\r\n  statusCode: number;\r\n  message: string;\r\n  details?: any;\r\n}\r\n\r\nexport class BatchRequestError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public errors: BatchError[],\r\n    public partial: boolean = false\r\n  ) {\r\n    super(message);\r\n    this.name = 'BatchRequestError';\r\n  }\r\n}\r\n\r\nexport class BatchRequestHandler {\r\n  private readonly batchEndpoint = \"https://www.googleapis.com/batch/calendar/v3\";\r\n  private readonly boundary: string;\r\n  private readonly maxRetries = 3;\r\n  private readonly baseDelay = 1000; // 1 second\r\n\r\n  constructor(private auth: OAuth2Client) {\r\n    this.boundary = \"batch_boundary_\" + Date.now();\r\n  }\r\n\r\n  async executeBatch(requests: BatchRequest[]): Promise<BatchResponse[]> {\r\n    if (requests.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    if (requests.length > 50) {\r\n      throw new Error('Batch requests cannot exceed 50 requests per batch');\r\n    }\r\n\r\n    return this.executeBatchWithRetry(requests, 0);\r\n  }\r\n\r\n  private async executeBatchWithRetry(requests: BatchRequest[], attempt: number): Promise<BatchResponse[]> {\r\n    try {\r\n      const batchBody = this.createBatchBody(requests);\r\n      const token = await this.auth.getAccessToken();\r\n      \r\n      const response = await fetch(this.batchEndpoint, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Authorization\": `Bearer ${token.token}`,\r\n          \"Content-Type\": `multipart/mixed; boundary=${this.boundary}`\r\n        },\r\n        body: batchBody\r\n      });\r\n\r\n      const responseText = await response.text();\r\n\r\n      // Handle rate limiting with retry\r\n      if (response.status === 429 && attempt < this.maxRetries) {\r\n        const retryAfter = response.headers.get('Retry-After');\r\n        const delay = retryAfter ? parseInt(retryAfter) * 1000 : this.baseDelay * Math.pow(2, attempt);\r\n        \r\n        console.warn(`Rate limited, retrying after ${delay}ms (attempt ${attempt + 1}/${this.maxRetries})`);\r\n        await this.sleep(delay);\r\n        return this.executeBatchWithRetry(requests, attempt + 1);\r\n      }\r\n\r\n      if (!response.ok) {\r\n        throw new BatchRequestError(\r\n          `Batch request failed: ${response.status} ${response.statusText}`,\r\n          [{\r\n            statusCode: response.status,\r\n            message: `HTTP ${response.status}: ${response.statusText}`,\r\n            details: responseText\r\n          }]\r\n        );\r\n      }\r\n\r\n      return this.parseBatchResponse(responseText);\r\n    } catch (error) {\r\n      if (error instanceof BatchRequestError) {\r\n        throw error;\r\n      }\r\n      \r\n      // Retry on network errors\r\n      if (attempt < this.maxRetries && this.isRetryableError(error)) {\r\n        const delay = this.baseDelay * Math.pow(2, attempt);\r\n        console.warn(`Network error, retrying after ${delay}ms (attempt ${attempt + 1}/${this.maxRetries}): ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n        await this.sleep(delay);\r\n        return this.executeBatchWithRetry(requests, attempt + 1);\r\n      }\r\n      \r\n      // Handle network or auth errors\r\n      throw new BatchRequestError(\r\n        `Failed to execute batch request: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n        [{\r\n          statusCode: 0,\r\n          message: error instanceof Error ? error.message : 'Unknown error',\r\n          details: error\r\n        }]\r\n      );\r\n    }\r\n  }\r\n\r\n  private isRetryableError(error: any): boolean {\r\n    if (error instanceof Error) {\r\n      const message = error.message.toLowerCase();\r\n      return message.includes('network') || \r\n             message.includes('timeout') || \r\n             message.includes('econnreset') ||\r\n             message.includes('enotfound');\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private sleep(ms: number): Promise<void> {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  private createBatchBody(requests: BatchRequest[]): string {\r\n    return requests.map((req, index) => {\r\n      const parts = [\r\n        `--${this.boundary}`,\r\n        `Content-Type: application/http`,\r\n        `Content-ID: <item${index + 1}>`,\r\n        \"\",\r\n        `${req.method} ${req.path} HTTP/1.1`\r\n      ];\r\n\r\n      if (req.headers) {\r\n        Object.entries(req.headers).forEach(([key, value]) => {\r\n          parts.push(`${key}: ${value}`);\r\n        });\r\n      }\r\n\r\n      if (req.body) {\r\n        parts.push(\"Content-Type: application/json\");\r\n        parts.push(\"\");\r\n        parts.push(JSON.stringify(req.body));\r\n      }\r\n\r\n      return parts.join(\"\\r\\n\");\r\n    }).join(\"\\r\\n\\r\\n\") + `\\r\\n--${this.boundary}--`;\r\n  }\r\n\r\n  private parseBatchResponse(responseText: string): BatchResponse[] {\r\n    // First, try to find boundary from Content-Type header in the response\r\n    // Google's responses typically have boundary in the first few lines\r\n    const lines = responseText.split(/\\r?\\n/);\r\n    let boundary = null;\r\n    \r\n    // Look for Content-Type header with boundary in the first few lines\r\n    for (let i = 0; i < Math.min(10, lines.length); i++) {\r\n      const line = lines[i];\r\n      if (line.toLowerCase().includes('content-type:') && line.includes('boundary=')) {\r\n        const boundaryMatch = line.match(/boundary=([^\\s\\r\\n;]+)/);\r\n        if (boundaryMatch) {\r\n          boundary = boundaryMatch[1];\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // If not found in headers, try to find boundary markers in the content\r\n    if (!boundary) {\r\n      const boundaryMatch = responseText.match(/--([a-zA-Z0-9_-]+)/);\r\n      if (boundaryMatch) {\r\n        boundary = boundaryMatch[1];\r\n      }\r\n    }\r\n    \r\n    if (!boundary) {\r\n      throw new Error('Could not find boundary in batch response');\r\n    }\r\n    \r\n    // Split by boundary markers\r\n    const parts = responseText.split(`--${boundary}`);\r\n    \r\n    const responses: BatchResponse[] = [];\r\n    \r\n    // Skip the first part (before the first boundary) and the last part (after final boundary with --)\r\n    for (let i = 1; i < parts.length; i++) {\r\n      const part = parts[i];\r\n      \r\n      // Skip empty parts or the final boundary marker\r\n      if (part.trim() === '' || part.trim() === '--' || part.trim().startsWith('--')) continue;\r\n      \r\n      const response = this.parseResponsePart(part);\r\n      if (response) {\r\n        responses.push(response);\r\n      }\r\n    }\r\n    \r\n    return responses;\r\n  }\r\n\r\n  private parseResponsePart(part: string): BatchResponse | null {\r\n    // Handle both \\r\\n and \\n line endings\r\n    const lines = part.split(/\\r?\\n/);\r\n    \r\n    // Find the HTTP response line (look for \"HTTP/1.1\")\r\n    let httpLineIndex = -1;\r\n    for (let i = 0; i < lines.length; i++) {\r\n      if (lines[i].startsWith('HTTP/1.1')) {\r\n        httpLineIndex = i;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (httpLineIndex === -1) return null;\r\n\r\n    // Parse status code from HTTP response line\r\n    const httpLine = lines[httpLineIndex];\r\n    const statusMatch = httpLine.match(/HTTP\\/1\\.1 (\\d+)/);\r\n    if (!statusMatch) return null;\r\n    \r\n    const statusCode = parseInt(statusMatch[1]);\r\n\r\n    // Parse response headers (start after HTTP line, stop at empty line)\r\n    const headers: Record<string, string> = {};\r\n    let bodyStartIndex = httpLineIndex + 1;\r\n    \r\n    for (let i = httpLineIndex + 1; i < lines.length; i++) {\r\n      const line = lines[i];\r\n      if (line.trim() === '') {\r\n        bodyStartIndex = i + 1;\r\n        break;\r\n      }\r\n      \r\n      const colonIndex = line.indexOf(':');\r\n      if (colonIndex > 0) {\r\n        const key = line.substring(0, colonIndex).trim();\r\n        const value = line.substring(colonIndex + 1).trim();\r\n        headers[key] = value;\r\n      }\r\n    }\r\n\r\n    // Parse body - everything after the empty line following headers\r\n    let body: any = null;\r\n    if (bodyStartIndex < lines.length) {\r\n      // Collect all body lines, filtering out empty lines at the end\r\n      const bodyLines = [];\r\n      for (let i = bodyStartIndex; i < lines.length; i++) {\r\n        bodyLines.push(lines[i]);\r\n      }\r\n      \r\n      // Remove trailing empty lines\r\n      while (bodyLines.length > 0 && bodyLines[bodyLines.length - 1].trim() === '') {\r\n        bodyLines.pop();\r\n      }\r\n      \r\n      if (bodyLines.length > 0) {\r\n        const bodyText = bodyLines.join('\\n');\r\n        if (bodyText.trim()) {\r\n          try {\r\n            body = JSON.parse(bodyText);\r\n          } catch {\r\n            // If JSON parsing fails, return the raw text\r\n            body = bodyText;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return {\r\n      statusCode,\r\n      headers,\r\n      body\r\n    };\r\n  }\r\n} ", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { ListEventsArgumentsSchema } from \"../../schemas/validators.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { BaseToolHandler } from \"./BaseToolHandler.js\";\r\nimport { google, calendar_v3 } from 'googleapis';\r\nimport { z } from 'zod';\r\nimport { formatEventList } from \"../utils.js\";\r\nimport { BatchRequestHandler } from \"./BatchRequestHandler.js\";\r\n\r\n// Extended event type to include calendar ID for tracking source\r\ninterface ExtendedEvent extends calendar_v3.Schema$Event {\r\n  calendarId: string;\r\n}\r\n\r\ntype ListEventsArgs = z.infer<typeof ListEventsArgumentsSchema>;\r\n\r\nexport class ListEventsHandler extends BaseToolHandler {\r\n    async runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n        const validArgs = ListEventsArgumentsSchema.parse(args);\r\n        \r\n        // Normalize calendarId to always be an array for consistent processing\r\n        const calendarIds = Array.isArray(validArgs.calendarId) \r\n            ? validArgs.calendarId \r\n            : [validArgs.calendarId];\r\n        \r\n        const allEvents = await this.fetchEvents(oauth2Client, calendarIds, {\r\n            timeMin: validArgs.timeMin,\r\n            timeMax: validArgs.timeMax\r\n        });\r\n        \r\n        return {\r\n            content: [{\r\n                type: \"text\",\r\n                text: this.formatEventList(allEvents, calendarIds),\r\n            }],\r\n        };\r\n    }\r\n\r\n    private async fetchEvents(\r\n        client: OAuth2Client,\r\n        calendarIds: string[],\r\n        options: { timeMin?: string; timeMax?: string }\r\n    ): Promise<ExtendedEvent[]> {\r\n        if (calendarIds.length === 1) {\r\n            return this.fetchSingleCalendarEvents(client, calendarIds[0], options);\r\n        }\r\n        \r\n        return this.fetchMultipleCalendarEvents(client, calendarIds, options);\r\n    }\r\n\r\n    private async fetchSingleCalendarEvents(\r\n        client: OAuth2Client,\r\n        calendarId: string,\r\n        options: { timeMin?: string; timeMax?: string }\r\n    ): Promise<ExtendedEvent[]> {\r\n        try {\r\n            const calendar = this.getCalendar(client);\r\n            const response = await calendar.events.list({\r\n                calendarId,\r\n                timeMin: options.timeMin,\r\n                timeMax: options.timeMax,\r\n                singleEvents: true,\r\n                orderBy: 'startTime'\r\n            });\r\n            \r\n            // Add calendarId to events for consistent interface\r\n            return (response.data.items || []).map(event => ({\r\n                ...event,\r\n                calendarId\r\n            }));\r\n        } catch (error) {\r\n            throw this.handleGoogleApiError(error);\r\n        }\r\n    }\r\n\r\n    private async fetchMultipleCalendarEvents(\r\n        client: OAuth2Client,\r\n        calendarIds: string[],\r\n        options: { timeMin?: string; timeMax?: string }\r\n    ): Promise<ExtendedEvent[]> {\r\n        const batchHandler = new BatchRequestHandler(client);\r\n        \r\n        const requests = calendarIds.map(calendarId => ({\r\n            method: \"GET\" as const,\r\n            path: this.buildEventsPath(calendarId, options)\r\n        }));\r\n        \r\n        const responses = await batchHandler.executeBatch(requests);\r\n        \r\n        const { events, errors } = this.processBatchResponses(responses, calendarIds);\r\n        \r\n        if (errors.length > 0) {\r\n            console.warn(\"Some calendars had errors:\", errors.map(e => `${e.calendarId}: ${e.error}`));\r\n        }\r\n        \r\n        return this.sortEventsByStartTime(events);\r\n    }\r\n\r\n    private buildEventsPath(calendarId: string, options: { timeMin?: string; timeMax?: string }): string {\r\n        const params = new URLSearchParams({\r\n            singleEvents: \"true\",\r\n            orderBy: \"startTime\",\r\n            ...(options.timeMin && { timeMin: options.timeMin }),\r\n            ...(options.timeMax && { timeMax: options.timeMax })\r\n        });\r\n        \r\n        return `/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?${params.toString()}`;\r\n    }\r\n\r\n    private processBatchResponses(\r\n        responses: any[], \r\n        calendarIds: string[]\r\n    ): { events: ExtendedEvent[]; errors: Array<{ calendarId: string; error: string }> } {\r\n        const events: ExtendedEvent[] = [];\r\n        const errors: Array<{ calendarId: string; error: string }> = [];\r\n        \r\n        responses.forEach((response, index) => {\r\n            const calendarId = calendarIds[index];\r\n            \r\n            if (response.statusCode === 200 && response.body?.items) {\r\n                const calendarEvents: ExtendedEvent[] = response.body.items.map((event: any) => ({\r\n                    ...event,\r\n                    calendarId\r\n                }));\r\n                events.push(...calendarEvents);\r\n            } else {\r\n                const errorMessage = response.body?.error?.message || \r\n                                   response.body?.message || \r\n                                   `HTTP ${response.statusCode}`;\r\n                errors.push({ calendarId, error: errorMessage });\r\n            }\r\n        });\r\n        \r\n        return { events, errors };\r\n    }\r\n\r\n    private sortEventsByStartTime(events: ExtendedEvent[]): ExtendedEvent[] {\r\n        return events.sort((a, b) => {\r\n            const aStart = a.start?.dateTime || a.start?.date || \"\";\r\n            const bStart = b.start?.dateTime || b.start?.date || \"\";\r\n            return aStart.localeCompare(bStart);\r\n        });\r\n    }\r\n\r\n    private formatEventList(events: ExtendedEvent[], calendarIds: string[]): string {\r\n        if (events.length === 0) {\r\n            return `No events found in ${calendarIds.length} calendar(s).`;\r\n        }\r\n        \r\n        if (calendarIds.length === 1) {\r\n            return formatEventList(events);\r\n        }\r\n        \r\n        return this.formatMultiCalendarEvents(events, calendarIds);\r\n    }\r\n\r\n    private formatMultiCalendarEvents(events: ExtendedEvent[], calendarIds: string[]): string {\r\n        const grouped = this.groupEventsByCalendar(events);\r\n        \r\n        let output = `Found ${events.length} events across ${calendarIds.length} calendars:\\n\\n`;\r\n        \r\n        for (const [calendarId, calEvents] of Object.entries(grouped)) {\r\n            output += `Calendar: ${calendarId}\\n`;\r\n            output += formatEventList(calEvents);\r\n            output += '\\n';\r\n        }\r\n        \r\n        return output;\r\n    }\r\n\r\n    private groupEventsByCalendar(events: ExtendedEvent[]): Record<string, ExtendedEvent[]> {\r\n        return events.reduce((acc, event) => {\r\n            const calId = event.calendarId;\r\n            if (!acc[calId]) acc[calId] = [];\r\n            acc[calId].push(event);\r\n            return acc;\r\n        }, {} as Record<string, ExtendedEvent[]>);\r\n    }\r\n}\r\n", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { SearchEventsArgumentsSchema } from \"../../schemas/validators.js\";\r\nimport { BaseToolHandler } from \"./BaseToolHandler.js\";\r\nimport { calendar_v3 } from 'googleapis';\r\nimport { z } from 'zod';\r\nimport { formatEventList } from \"../utils.js\";\r\n\r\nexport class SearchEventsHandler extends BaseToolHandler {\r\n    async runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n        const validArgs = SearchEventsArgumentsSchema.parse(args);\r\n        const events = await this.searchEvents(oauth2Client, validArgs);\r\n        return {\r\n            content: [{\r\n                type: \"text\",\r\n                text: formatEventList(events),\r\n            }],\r\n        };\r\n    }\r\n\r\n    private async searchEvents(\r\n        client: OAuth2Client,\r\n        args: z.infer<typeof SearchEventsArgumentsSchema>\r\n    ): Promise<calendar_v3.Schema$Event[]> {\r\n        try {\r\n            const calendar = this.getCalendar(client);\r\n            const response = await calendar.events.list({\r\n                calendarId: args.calendarId,\r\n                q: args.query,\r\n                timeMin: args.timeMin,\r\n                timeMax: args.timeMax,\r\n                singleEvents: true,\r\n                orderBy: 'startTime',\r\n            });\r\n            return response.data.items || [];\r\n        } catch (error) {\r\n            throw this.handleGoogleApiError(error);\r\n        }\r\n    }\r\n}\r\n", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { BaseToolHandler } from \"./BaseToolHandler.js\";\r\nimport { calendar_v3 } from \"googleapis\";\r\n\r\nexport class ListColorsHandler extends BaseToolHandler {\r\n    async runTool(_: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n        const colors = await this.listColors(oauth2Client);\r\n        return {\r\n            content: [{\r\n                type: \"text\",\r\n                text: `Available event colors:\\n${this.formatColorList(colors)}`,\r\n            }],\r\n        };\r\n    }\r\n\r\n    private async listColors(client: OAuth2Client): Promise<calendar_v3.Schema$Colors> {\r\n        try {\r\n            const calendar = this.getCalendar(client);\r\n            const response = await calendar.colors.get();\r\n            if (!response.data) throw new Error('Failed to retrieve colors');\r\n            return response.data;\r\n        } catch (error) {\r\n            throw this.handleGoogleApiError(error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Formats the color information into a user-friendly string.\r\n     */\r\n    private formatColorList(colors: calendar_v3.Schema$Colors): string {\r\n        const eventColors = colors.event || {};\r\n        return Object.entries(eventColors)\r\n            .map(([id, colorInfo]) => `Color ID: ${id} - ${colorInfo.background} (background) / ${colorInfo.foreground} (foreground)`)\r\n            .join(\"\\n\");\r\n    }\r\n}\r\n", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { CreateEventArgumentsSchema } from \"../../schemas/validators.js\";\r\nimport { BaseToolHandler } from \"./BaseToolHandler.js\";\r\nimport { calendar_v3, google } from 'googleapis';\r\nimport { z } from 'zod';\r\n\r\nexport class CreateEventHandler extends BaseToolHandler {\r\n    async runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n        const validArgs = CreateEventArgumentsSchema.parse(args);\r\n        const event = await this.createEvent(oauth2Client, validArgs);\r\n        return {\r\n            content: [{\r\n                type: \"text\",\r\n                text: `Event created: ${event.summary} (${event.id})`,\r\n            }],\r\n        };\r\n    }\r\n\r\n    private async createEvent(\r\n        client: OAuth2Client,\r\n        args: z.infer<typeof CreateEventArgumentsSchema>\r\n    ): Promise<calendar_v3.Schema$Event> {\r\n        try {\r\n            const calendar = this.getCalendar(client);\r\n            const requestBody: calendar_v3.Schema$Event = {\r\n                summary: args.summary,\r\n                description: args.description,\r\n                start: { dateTime: args.start, timeZone: args.timeZone },\r\n                end: { dateTime: args.end, timeZone: args.timeZone },\r\n                attendees: args.attendees,\r\n                location: args.location,\r\n                colorId: args.colorId,\r\n                reminders: args.reminders,\r\n                recurrence: args.recurrence,\r\n            };\r\n            \r\n            // Try to create the event with built-in retry logic\r\n            const response = await calendar.events.insert({\r\n                calendarId: args.calendarId,\r\n                requestBody: requestBody,\r\n            });\r\n            \r\n            if (!response.data) throw new Error('Failed to create event, no data returned');\r\n            return response.data;\r\n        } catch (error: any) {\r\n            // If it's a socket error but we get a response, check if event was created\r\n            if (error.code === 'ECONNRESET' || error.code === 'ETIMEDOUT') {\r\n                try {\r\n                    // Wait a bit and then check if the event was created\r\n                    await new Promise(resolve => setTimeout(resolve, 1000));\r\n                    \r\n                    const calendar = this.getCalendar(client);\r\n                    const now = new Date();\r\n                    const events = await calendar.events.list({\r\n                        calendarId: args.calendarId,\r\n                        timeMin: new Date(now.getTime() - 60000).toISOString(), // Last minute\r\n                        singleEvents: true,\r\n                        orderBy: 'startTime',\r\n                        maxResults: 10,\r\n                    });\r\n                    \r\n                    // Look for the event we just tried to create\r\n                    const createdEvent = events.data.items?.find(\r\n                        event => event.summary === args.summary && \r\n                                event.start?.dateTime === args.start &&\r\n                                event.end?.dateTime === args.end\r\n                    );\r\n                    \r\n                    if (createdEvent) {\r\n                        // Event was created despite the error\r\n                        return createdEvent;\r\n                    }\r\n                } catch (checkError) {\r\n                    // If check fails, throw the original error\r\n                }\r\n            }\r\n            \r\n            throw this.handleGoogleApiError(error);\r\n        }\r\n    }\r\n}", "import { calendar_v3 } from 'googleapis';\r\n\r\nexport class RecurringEventHelpers {\r\n  private calendar: calendar_v3.Calendar;\r\n\r\n  constructor(calendar: calendar_v3.Calendar) {\r\n    this.calendar = calendar;\r\n  }\r\n\r\n  /**\r\n   * Get the calendar instance\r\n   */\r\n  getCalendar(): calendar_v3.Calendar {\r\n    return this.calendar;\r\n  }\r\n\r\n  /**\r\n   * Detects if an event is recurring or single\r\n   */\r\n  async detectEventType(eventId: string, calendarId: string): Promise<'recurring' | 'single'> {\r\n    const response = await this.calendar.events.get({\r\n      calendarId,\r\n      eventId\r\n    });\r\n\r\n    const event = response.data;\r\n    return event.recurrence && event.recurrence.length > 0 ? 'recurring' : 'single';\r\n  }\r\n\r\n  /**\r\n   * Formats an instance ID for single instance updates\r\n   */\r\n  formatInstanceId(eventId: string, originalStartTime: string): string {\r\n    // Convert to UTC first, then format to basic format: YYYYMMDDTHHMMSSZ\r\n    const utcDate = new Date(originalStartTime);\r\n    const basicTimeFormat = utcDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\r\n    \r\n    return `${eventId}_${basicTimeFormat}`;\r\n  }\r\n\r\n  /**\r\n   * Calculates the UNTIL date for future instance updates\r\n   */\r\n  calculateUntilDate(futureStartDate: string): string {\r\n    const futureDate = new Date(futureStartDate);\r\n    const untilDate = new Date(futureDate.getTime() - 86400000); // -1 day\r\n    return untilDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\r\n  }\r\n\r\n  /**\r\n   * Calculates end time based on original duration\r\n   */\r\n  calculateEndTime(newStartTime: string, originalEvent: calendar_v3.Schema$Event): string {\r\n    const newStart = new Date(newStartTime);\r\n    const originalStart = new Date(originalEvent.start!.dateTime!);\r\n    const originalEnd = new Date(originalEvent.end!.dateTime!);\r\n    const duration = originalEnd.getTime() - originalStart.getTime();\r\n    \r\n    return new Date(newStart.getTime() + duration).toISOString();\r\n  }\r\n\r\n  /**\r\n   * Updates recurrence rule with UNTIL clause\r\n   */\r\n  updateRecurrenceWithUntil(recurrence: string[], untilDate: string): string[] {\r\n    if (!recurrence || recurrence.length === 0) {\r\n      throw new Error('No recurrence rule found');\r\n    }\r\n\r\n    const updatedRecurrence: string[] = [];\r\n    let foundRRule = false;\r\n\r\n    for (const rule of recurrence) {\r\n      if (rule.startsWith('RRULE:')) {\r\n        foundRRule = true;\r\n        const updatedRule = rule\r\n          .replace(/;UNTIL=\\d{8}T\\d{6}Z/g, '') // Remove existing UNTIL\r\n          .replace(/;COUNT=\\d+/g, '') // Remove COUNT if present\r\n          + `;UNTIL=${untilDate}`;\r\n        updatedRecurrence.push(updatedRule);\r\n      } else {\r\n        // Preserve EXDATE, RDATE, and other rules as-is\r\n        updatedRecurrence.push(rule);\r\n      }\r\n    }\r\n\r\n    if (!foundRRule) {\r\n      throw new Error('No RRULE found in recurrence rules');\r\n    }\r\n\r\n    return updatedRecurrence;\r\n  }\r\n\r\n  /**\r\n   * Cleans event fields for new event creation\r\n   */\r\n  cleanEventForDuplication(event: calendar_v3.Schema$Event): calendar_v3.Schema$Event {\r\n    const cleanedEvent = { ...event };\r\n    \r\n    // Remove fields that shouldn't be duplicated\r\n    delete cleanedEvent.id;\r\n    delete cleanedEvent.etag;\r\n    delete cleanedEvent.iCalUID;\r\n    delete cleanedEvent.created;\r\n    delete cleanedEvent.updated;\r\n    delete cleanedEvent.htmlLink;\r\n    delete cleanedEvent.hangoutLink;\r\n    \r\n    return cleanedEvent;\r\n  }\r\n\r\n  /**\r\n   * Builds request body for event updates\r\n   */\r\n  buildUpdateRequestBody(args: any): calendar_v3.Schema$Event {\r\n    const requestBody: calendar_v3.Schema$Event = {};\r\n\r\n    if (args.summary !== undefined && args.summary !== null) requestBody.summary = args.summary;\r\n    if (args.description !== undefined && args.description !== null) requestBody.description = args.description;\r\n    if (args.location !== undefined && args.location !== null) requestBody.location = args.location;\r\n    if (args.colorId !== undefined && args.colorId !== null) requestBody.colorId = args.colorId;\r\n    if (args.attendees !== undefined && args.attendees !== null) requestBody.attendees = args.attendees;\r\n    if (args.reminders !== undefined && args.reminders !== null) requestBody.reminders = args.reminders;\r\n    if (args.recurrence !== undefined && args.recurrence !== null) requestBody.recurrence = args.recurrence;\r\n\r\n    // Handle time changes\r\n    let timeChanged = false;\r\n    if (args.start !== undefined && args.start !== null) {\r\n      requestBody.start = { dateTime: args.start, timeZone: args.timeZone };\r\n      timeChanged = true;\r\n    }\r\n    if (args.end !== undefined && args.end !== null) {\r\n      requestBody.end = { dateTime: args.end, timeZone: args.timeZone };\r\n      timeChanged = true;\r\n    }\r\n\r\n    // Only add timezone objects if there were actual time changes, OR if neither start/end provided but timezone is given\r\n    if (timeChanged || (!args.start && !args.end && args.timeZone)) {\r\n      if (!requestBody.start) requestBody.start = {};\r\n      if (!requestBody.end) requestBody.end = {};\r\n      if (!requestBody.start.timeZone) requestBody.start.timeZone = args.timeZone;\r\n      if (!requestBody.end.timeZone) requestBody.end.timeZone = args.timeZone;\r\n    }\r\n\r\n    return requestBody;\r\n  }\r\n}\r\n\r\n/**\r\n * Custom error class for recurring event errors\r\n */\r\nexport class RecurringEventError extends Error {\r\n  public code: string;\r\n\r\n  constructor(message: string, code: string) {\r\n    super(message);\r\n    this.name = 'RecurringEventError';\r\n    this.code = code;\r\n  }\r\n}\r\n\r\nexport const RECURRING_EVENT_ERRORS = {\r\n  INVALID_SCOPE: 'INVALID_MODIFICATION_SCOPE',\r\n  MISSING_ORIGINAL_TIME: 'MISSING_ORIGINAL_START_TIME',\r\n  MISSING_FUTURE_DATE: 'MISSING_FUTURE_START_DATE',\r\n  PAST_FUTURE_DATE: 'FUTURE_DATE_IN_PAST',\r\n  NON_RECURRING_SCOPE: 'SCOPE_NOT_APPLICABLE_TO_SINGLE_EVENT'\r\n}; ", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { UpdateEventArgumentsSchema } from \"../../schemas/validators.js\";\r\nimport { BaseToolHandler } from \"./BaseToolHandler.js\";\r\nimport { calendar_v3 } from 'googleapis';\r\nimport { z } from 'zod';\r\nimport { RecurringEventHelpers, RecurringEventError, RECURRING_EVENT_ERRORS } from './RecurringEventHelpers.js';\r\n\r\nexport class UpdateEventHandler extends BaseToolHandler {\r\n    async runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n        const validArgs = UpdateEventArgumentsSchema.parse(args);\r\n        const event = await this.updateEventWithScope(oauth2Client, validArgs);\r\n        return {\r\n            content: [{\r\n                type: \"text\",\r\n                text: `Event updated: ${event.summary} (${event.id})`,\r\n            }],\r\n        };\r\n    }\r\n\r\n    private async updateEventWithScope(\r\n        client: OAuth2Client,\r\n        args: z.infer<typeof UpdateEventArgumentsSchema>\r\n    ): Promise<calendar_v3.Schema$Event> {\r\n        try {\r\n            const calendar = this.getCalendar(client);\r\n            const helpers = new RecurringEventHelpers(calendar);\r\n            \r\n            // Detect event type and validate scope usage\r\n            const eventType = await helpers.detectEventType(args.eventId, args.calendarId);\r\n            \r\n            if (args.modificationScope !== 'all' && eventType !== 'recurring') {\r\n                throw new RecurringEventError(\r\n                    'Scope other than \"all\" only applies to recurring events',\r\n                    RECURRING_EVENT_ERRORS.NON_RECURRING_SCOPE\r\n                );\r\n            }\r\n            \r\n            switch (args.modificationScope) {\r\n                case 'single':\r\n                    return this.updateSingleInstance(helpers, args);\r\n                case 'all':\r\n                    return this.updateAllInstances(helpers, args);\r\n                case 'future':\r\n                    return this.updateFutureInstances(helpers, args);\r\n                default:\r\n                    throw new RecurringEventError(\r\n                        `Invalid modification scope: ${args.modificationScope}`,\r\n                        RECURRING_EVENT_ERRORS.INVALID_SCOPE\r\n                    );\r\n            }\r\n        } catch (error) {\r\n            if (error instanceof RecurringEventError) {\r\n                throw error;\r\n            }\r\n            throw this.handleGoogleApiError(error);\r\n        }\r\n    }\r\n\r\n    private async updateSingleInstance(\r\n        helpers: RecurringEventHelpers,\r\n        args: z.infer<typeof UpdateEventArgumentsSchema>\r\n    ): Promise<calendar_v3.Schema$Event> {\r\n        if (!args.originalStartTime) {\r\n            throw new RecurringEventError(\r\n                'originalStartTime is required for single instance updates',\r\n                RECURRING_EVENT_ERRORS.MISSING_ORIGINAL_TIME\r\n            );\r\n        }\r\n\r\n        const calendar = helpers.getCalendar();\r\n        const instanceId = helpers.formatInstanceId(args.eventId, args.originalStartTime);\r\n        \r\n        const response = await calendar.events.patch({\r\n            calendarId: args.calendarId,\r\n            eventId: instanceId,\r\n            requestBody: helpers.buildUpdateRequestBody(args)\r\n        });\r\n\r\n        if (!response.data) throw new Error('Failed to update event instance');\r\n        return response.data;\r\n    }\r\n\r\n    private async updateAllInstances(\r\n        helpers: RecurringEventHelpers,\r\n        args: z.infer<typeof UpdateEventArgumentsSchema>\r\n    ): Promise<calendar_v3.Schema$Event> {\r\n        const calendar = helpers.getCalendar();\r\n        \r\n        const response = await calendar.events.patch({\r\n            calendarId: args.calendarId,\r\n            eventId: args.eventId,\r\n            requestBody: helpers.buildUpdateRequestBody(args)\r\n        });\r\n\r\n        if (!response.data) throw new Error('Failed to update event');\r\n        return response.data;\r\n    }\r\n\r\n    private async updateFutureInstances(\r\n        helpers: RecurringEventHelpers,\r\n        args: z.infer<typeof UpdateEventArgumentsSchema>\r\n    ): Promise<calendar_v3.Schema$Event> {\r\n        if (!args.futureStartDate) {\r\n            throw new RecurringEventError(\r\n                'futureStartDate is required for future instance updates',\r\n                RECURRING_EVENT_ERRORS.MISSING_FUTURE_DATE\r\n            );\r\n        }\r\n\r\n        const calendar = helpers.getCalendar();\r\n\r\n        // 1. Get original event\r\n        const originalResponse = await calendar.events.get({\r\n            calendarId: args.calendarId,\r\n            eventId: args.eventId\r\n        });\r\n        const originalEvent = originalResponse.data;\r\n\r\n        if (!originalEvent.recurrence) {\r\n            throw new Error('Event does not have recurrence rules');\r\n        }\r\n\r\n        // 2. Calculate UNTIL date and update original event\r\n        const untilDate = helpers.calculateUntilDate(args.futureStartDate);\r\n        const updatedRecurrence = helpers.updateRecurrenceWithUntil(originalEvent.recurrence, untilDate);\r\n\r\n        await calendar.events.patch({\r\n            calendarId: args.calendarId,\r\n            eventId: args.eventId,\r\n            requestBody: { recurrence: updatedRecurrence }\r\n        });\r\n\r\n        // 3. Create new recurring event starting from future date\r\n        const requestBody = helpers.buildUpdateRequestBody(args);\r\n        \r\n        // Calculate end time if start time is changing\r\n        let endTime = args.end;\r\n        if (args.start || args.futureStartDate) {\r\n            const newStartTime = args.start || args.futureStartDate;\r\n            endTime = endTime || helpers.calculateEndTime(newStartTime, originalEvent);\r\n        }\r\n\r\n        const newEvent = {\r\n            ...helpers.cleanEventForDuplication(originalEvent),\r\n            ...requestBody,\r\n            start: { \r\n                dateTime: args.start || args.futureStartDate, \r\n                timeZone: args.timeZone \r\n            },\r\n            end: { \r\n                dateTime: endTime, \r\n                timeZone: args.timeZone \r\n            }\r\n        };\r\n\r\n        const response = await calendar.events.insert({\r\n            calendarId: args.calendarId,\r\n            requestBody: newEvent\r\n        });\r\n\r\n        if (!response.data) throw new Error('Failed to create new recurring event');\r\n        return response.data;\r\n    }\r\n\r\n    // Keep the original updateEvent method for backward compatibility\r\n    private async updateEvent(\r\n        client: OAuth2Client,\r\n        args: z.infer<typeof UpdateEventArgumentsSchema>\r\n    ): Promise<calendar_v3.Schema$Event> {\r\n        // This method now just delegates to the enhanced version\r\n        return this.updateEventWithScope(client, args);\r\n    }\r\n}\r\n", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { DeleteEventArgumentsSchema } from \"../../schemas/validators.js\";\r\nimport { BaseToolHandler } from \"./BaseToolHandler.js\";\r\nimport { z } from 'zod';\r\n\r\nexport class DeleteEventHandler extends BaseToolHandler {\r\n    async runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n        const validArgs = DeleteEventArgumentsSchema.parse(args);\r\n        await this.deleteEvent(oauth2Client, validArgs);\r\n        return {\r\n            content: [{\r\n                type: \"text\",\r\n                text: \"Event deleted successfully\",\r\n            }],\r\n        };\r\n    }\r\n\r\n    private async deleteEvent(\r\n        client: OAuth2Client,\r\n        args: z.infer<typeof DeleteEventArgumentsSchema>\r\n    ): Promise<void> {\r\n        try {\r\n            const calendar = this.getCalendar(client);\r\n            await calendar.events.delete({\r\n                calendarId: args.calendarId,\r\n                eventId: args.eventId,\r\n            });\r\n        } catch (error) {\r\n            throw this.handleGoogleApiError(error);\r\n        }\r\n    }\r\n}\r\n", "import { BaseToolHandler } from './BaseToolHandler.js';\r\nimport { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { FreeBusyEventArgumentsSchema } from \"../../schemas/validators.js\";\r\nimport { z } from \"zod\";\r\nimport { FreeBusyResponse } from '../../schemas/types.js';\r\n\r\nexport class FreeBusyEventHandler extends BaseToolHandler {\r\n  async runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n\r\n    const validArgs = FreeBusyEventArgumentsSchema.safeParse(args);\r\n    if (!validArgs.success) {\r\n      throw new Error(\r\n          `Invalid arguments Error: ${JSON.stringify(validArgs.error.issues)}`\r\n      );\r\n    }\r\n\r\n    if(!this.isLessThanThreeMonths(validArgs.data.timeMin,validArgs.data.timeMax)){\r\n      return {\r\n        content: [{\r\n          type: \"text\",\r\n          text: \"The time gap between timeMin and timeMax must be less than 3 months\",\r\n        }],\r\n      }\r\n    }\r\n\r\n    const result = await this.queryFreeBusy(oauth2Client, validArgs.data);\r\n    const summaryText = this.generateAvailabilitySummary(result);\r\n\r\n    return {\r\n      content: [{\r\n        type: \"text\",\r\n        text: summaryText,\r\n      }]\r\n    };\r\n  }\r\n\r\n  private async queryFreeBusy(\r\n    client: OAuth2Client,\r\n    args: z.infer<typeof FreeBusyEventArgumentsSchema>\r\n  ): Promise<FreeBusyResponse> {\r\n    try {\r\n      const calendar = this.getCalendar(client);\r\n      const response = await calendar.freebusy.query({\r\n        requestBody: {\r\n          timeMin: args.timeMin,\r\n          timeMax: args.timeMax,\r\n          timeZone: args.timeZone,\r\n          groupExpansionMax: args.groupExpansionMax,\r\n          calendarExpansionMax: args.calendarExpansionMax,\r\n          items: args.items,\r\n        },\r\n      });\r\n      return response.data as FreeBusyResponse;\r\n    } catch (error) {\r\n      throw this.handleGoogleApiError(error);\r\n    }\r\n  }\r\n\r\n  private isLessThanThreeMonths (timeMin: string, timeMax: string): boolean {\r\n    const minDate = new Date(timeMin);\r\n    const maxDate = new Date(timeMax);\r\n\r\n    const diffInMilliseconds = maxDate.getTime() - minDate.getTime();\r\n    const threeMonthsInMilliseconds = 3 * 30 * 24 * 60 * 60 * 1000;\r\n\r\n    // Check if the difference is less than or equal to 3 months\r\n    return diffInMilliseconds <= threeMonthsInMilliseconds;\r\n  };\r\n\r\n  private generateAvailabilitySummary(response: FreeBusyResponse): string {\r\n    return Object.entries(response.calendars)\r\n      .map(([email, calendarInfo]) => {\r\n        if (calendarInfo.errors?.some(error => error.reason === \"notFound\")) {\r\n          return `Cannot check availability for ${email} (account not found)\\n`;\r\n        }\r\n\r\n        if (calendarInfo.busy.length === 0) {\r\n          return `${email} is available during ${response.timeMin} to ${response.timeMax}, please schedule calendar to ${email} if you want \\n`;\r\n        }\r\n\r\n        const busyTimes = calendarInfo.busy\r\n          .map(slot => `- From ${slot.start} to ${slot.end}`)\r\n          .join(\"\\n\");\r\n        return `${email} is busy during:\\n${busyTimes}\\n`;\r\n      })\r\n      .join(\"\\n\")\r\n      .trim();\r\n  }\r\n}\r\n", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, people_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface ListContactsArgs {\r\n  pageSize?: number;\r\n  pageToken?: string;\r\n  personFields?: string[];\r\n  sources?: string[];\r\n  query?: string;\r\n}\r\n\r\nexport class ListContactsHandler extends BaseToolHandler {\r\n  async runTool(args: ListContactsArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const people = google.people({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Default person fields if not specified\r\n      const personFields = args.personFields && args.personFields.length > 0 \r\n        ? args.personFields.join(',')\r\n        : 'names,emailAddresses,phoneNumbers,addresses,organizations,biographies,photos';\r\n      \r\n      // Default sources if not specified\r\n      const sources = args.sources && args.sources.length > 0\r\n        ? args.sources\r\n        : ['READ_SOURCE_TYPE_CONTACT'];\r\n      \r\n      const response = await people.people.connections.list({\r\n        resourceName: 'people/me',\r\n        pageSize: args.pageSize || 100,\r\n        pageToken: args.pageToken,\r\n        personFields,\r\n        sources,\r\n        ...(args.query && { query: args.query })\r\n      });\r\n\r\n      const contacts = response.data.connections || [];\r\n      const formattedContacts = contacts.map(contact => this.formatContact(contact));\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              contacts: formattedContacts,\r\n              totalItems: response.data.totalItems || formattedContacts.length,\r\n              nextPageToken: response.data.nextPageToken || null\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private formatContact(contact: people_v1.Schema$Person): any {\r\n    return {\r\n      resourceName: contact.resourceName,\r\n      etag: contact.etag,\r\n      names: contact.names?.map(name => ({\r\n        displayName: name.displayName,\r\n        familyName: name.familyName,\r\n        givenName: name.givenName,\r\n        middleName: name.middleName,\r\n        honorificPrefix: name.honorificPrefix,\r\n        honorificSuffix: name.honorificSuffix\r\n      })),\r\n      emailAddresses: contact.emailAddresses?.map(email => ({\r\n        value: email.value,\r\n        type: email.type,\r\n        formattedType: email.formattedType\r\n      })),\r\n      phoneNumbers: contact.phoneNumbers?.map(phone => ({\r\n        value: phone.value,\r\n        type: phone.type,\r\n        formattedType: phone.formattedType\r\n      })),\r\n      addresses: contact.addresses?.map(address => ({\r\n        formattedValue: address.formattedValue,\r\n        type: address.type,\r\n        formattedType: address.formattedType,\r\n        streetAddress: address.streetAddress,\r\n        city: address.city,\r\n        region: address.region,\r\n        postalCode: address.postalCode,\r\n        country: address.country,\r\n        countryCode: address.countryCode\r\n      })),\r\n      organizations: contact.organizations?.map(org => ({\r\n        name: org.name,\r\n        title: org.title,\r\n        department: org.department,\r\n        type: org.type,\r\n        formattedType: org.formattedType\r\n      })),\r\n      biographies: contact.biographies?.map(bio => ({\r\n        value: bio.value,\r\n        contentType: bio.contentType\r\n      })),\r\n      photos: contact.photos?.map(photo => ({\r\n        url: photo.url,\r\n        default: photo.default\r\n      }))\r\n    };\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, people_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface GetContactArgs {\r\n  resourceName: string;\r\n  personFields?: string[];\r\n}\r\n\r\nexport class GetContactHandler extends BaseToolHandler {\r\n  async runTool(args: GetContactArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const people = google.people({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Default person fields if not specified\r\n      const personFields = args.personFields && args.personFields.length > 0 \r\n        ? args.personFields.join(',')\r\n        : 'names,emailAddresses,phoneNumbers,addresses,organizations,biographies,photos,birthdays,events,relations,urls,userDefined,memberships,metadata';\r\n      \r\n      const response = await people.people.get({\r\n        resourceName: args.resourceName,\r\n        personFields\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              contact: this.formatContact(response.data)\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private formatContact(contact: people_v1.Schema$Person): any {\r\n    return {\r\n      resourceName: contact.resourceName,\r\n      etag: contact.etag,\r\n      metadata: contact.metadata,\r\n      names: contact.names?.map(name => ({\r\n        displayName: name.displayName,\r\n        familyName: name.familyName,\r\n        givenName: name.givenName,\r\n        middleName: name.middleName,\r\n        honorificPrefix: name.honorificPrefix,\r\n        honorificSuffix: name.honorificSuffix,\r\n        metadata: name.metadata\r\n      })),\r\n      emailAddresses: contact.emailAddresses?.map(email => ({\r\n        value: email.value,\r\n        type: email.type,\r\n        formattedType: email.formattedType,\r\n        metadata: email.metadata\r\n      })),\r\n      phoneNumbers: contact.phoneNumbers?.map(phone => ({\r\n        value: phone.value,\r\n        type: phone.type,\r\n        formattedType: phone.formattedType,\r\n        canonicalForm: phone.canonicalForm,\r\n        metadata: phone.metadata\r\n      })),\r\n      addresses: contact.addresses?.map(address => ({\r\n        formattedValue: address.formattedValue,\r\n        type: address.type,\r\n        formattedType: address.formattedType,\r\n        streetAddress: address.streetAddress,\r\n        extendedAddress: address.extendedAddress,\r\n        poBox: address.poBox,\r\n        city: address.city,\r\n        region: address.region,\r\n        postalCode: address.postalCode,\r\n        country: address.country,\r\n        countryCode: address.countryCode,\r\n        metadata: address.metadata\r\n      })),\r\n      organizations: contact.organizations?.map(org => ({\r\n        name: org.name,\r\n        phoneticName: org.phoneticName,\r\n        title: org.title,\r\n        department: org.department,\r\n        symbol: org.symbol,\r\n        location: org.location,\r\n        type: org.type,\r\n        formattedType: org.formattedType,\r\n        startDate: org.startDate,\r\n        endDate: org.endDate,\r\n        current: org.current,\r\n        metadata: org.metadata\r\n      })),\r\n      biographies: contact.biographies?.map(bio => ({\r\n        value: bio.value,\r\n        contentType: bio.contentType,\r\n        metadata: bio.metadata\r\n      })),\r\n      birthdays: contact.birthdays?.map(birthday => ({\r\n        date: birthday.date,\r\n        text: birthday.text,\r\n        metadata: birthday.metadata\r\n      })),\r\n      events: contact.events?.map(event => ({\r\n        date: event.date,\r\n        type: event.type,\r\n        formattedType: event.formattedType,\r\n        metadata: event.metadata\r\n      })),\r\n      relations: contact.relations?.map(relation => ({\r\n        person: relation.person,\r\n        type: relation.type,\r\n        formattedType: relation.formattedType,\r\n        metadata: relation.metadata\r\n      })),\r\n      urls: contact.urls?.map(url => ({\r\n        value: url.value,\r\n        type: url.type,\r\n        formattedType: url.formattedType,\r\n        metadata: url.metadata\r\n      })),\r\n      memberships: contact.memberships?.map(membership => ({\r\n        contactGroupMembership: membership.contactGroupMembership,\r\n        domainMembership: membership.domainMembership,\r\n        metadata: membership.metadata\r\n      })),\r\n      photos: contact.photos?.map(photo => ({\r\n        url: photo.url,\r\n        default: photo.default,\r\n        metadata: photo.metadata\r\n      }))\r\n    };\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, people_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface CreateContactArgs {\r\n  givenName?: string;\r\n  familyName?: string;\r\n  middleName?: string;\r\n  displayName?: string;\r\n  emailAddresses?: Array<{\r\n    value: string;\r\n    type?: string;\r\n  }>;\r\n  phoneNumbers?: Array<{\r\n    value: string;\r\n    type?: string;\r\n  }>;\r\n  addresses?: Array<{\r\n    streetAddress?: string;\r\n    city?: string;\r\n    region?: string;\r\n    postalCode?: string;\r\n    country?: string;\r\n    type?: string;\r\n  }>;\r\n  organizations?: Array<{\r\n    name?: string;\r\n    title?: string;\r\n    department?: string;\r\n    type?: string;\r\n  }>;\r\n  biographies?: Array<{\r\n    value: string;\r\n    contentType?: string;\r\n  }>;\r\n  notes?: string;\r\n}\r\n\r\nexport class CreateContactHandler extends BaseToolHandler {\r\n  async runTool(args: CreateContactArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const people = google.people({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Build the person object\r\n      const person: people_v1.Schema$Person = {};\r\n      \r\n      // Names\r\n      if (args.givenName || args.familyName || args.middleName || args.displayName) {\r\n        person.names = [{\r\n          givenName: args.givenName,\r\n          familyName: args.familyName,\r\n          middleName: args.middleName,\r\n          displayName: args.displayName || `${args.givenName || ''} ${args.familyName || ''}`.trim()\r\n        }];\r\n      }\r\n      \r\n      // Email addresses\r\n      if (args.emailAddresses && args.emailAddresses.length > 0) {\r\n        person.emailAddresses = args.emailAddresses.map(email => ({\r\n          value: email.value,\r\n          type: email.type || 'home'\r\n        }));\r\n      }\r\n      \r\n      // Phone numbers\r\n      if (args.phoneNumbers && args.phoneNumbers.length > 0) {\r\n        person.phoneNumbers = args.phoneNumbers.map(phone => ({\r\n          value: phone.value,\r\n          type: phone.type || 'home'\r\n        }));\r\n      }\r\n      \r\n      // Addresses\r\n      if (args.addresses && args.addresses.length > 0) {\r\n        person.addresses = args.addresses.map(address => ({\r\n          streetAddress: address.streetAddress,\r\n          city: address.city,\r\n          region: address.region,\r\n          postalCode: address.postalCode,\r\n          country: address.country,\r\n          type: address.type || 'home'\r\n        }));\r\n      }\r\n      \r\n      // Organizations\r\n      if (args.organizations && args.organizations.length > 0) {\r\n        person.organizations = args.organizations.map(org => ({\r\n          name: org.name,\r\n          title: org.title,\r\n          department: org.department,\r\n          type: org.type || 'work'\r\n        }));\r\n      }\r\n      \r\n      // Biographies\r\n      if (args.biographies && args.biographies.length > 0) {\r\n        person.biographies = args.biographies;\r\n      } else if (args.notes) {\r\n        // Use notes as a biography if no biographies provided\r\n        person.biographies = [{\r\n          value: args.notes,\r\n          contentType: 'TEXT_PLAIN'\r\n        }];\r\n      }\r\n      \r\n      const response = await people.people.createContact({\r\n        requestBody: person,\r\n        personFields: 'names,emailAddresses,phoneNumbers,addresses,organizations,biographies'\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              contact: {\r\n                resourceName: response.data.resourceName,\r\n                etag: response.data.etag,\r\n                ...this.formatContactResponse(response.data)\r\n              }\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private formatContactResponse(contact: people_v1.Schema$Person): any {\r\n    return {\r\n      names: contact.names,\r\n      emailAddresses: contact.emailAddresses,\r\n      phoneNumbers: contact.phoneNumbers,\r\n      addresses: contact.addresses,\r\n      organizations: contact.organizations,\r\n      biographies: contact.biographies\r\n    };\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, people_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface UpdateContactArgs {\r\n  resourceName: string;\r\n  updatePersonFields: string[];\r\n  givenName?: string;\r\n  familyName?: string;\r\n  middleName?: string;\r\n  displayName?: string;\r\n  emailAddresses?: Array<{\r\n    value: string;\r\n    type?: string;\r\n  }>;\r\n  phoneNumbers?: Array<{\r\n    value: string;\r\n    type?: string;\r\n  }>;\r\n  addresses?: Array<{\r\n    streetAddress?: string;\r\n    city?: string;\r\n    region?: string;\r\n    postalCode?: string;\r\n    country?: string;\r\n    type?: string;\r\n  }>;\r\n  organizations?: Array<{\r\n    name?: string;\r\n    title?: string;\r\n    department?: string;\r\n    type?: string;\r\n  }>;\r\n  biographies?: Array<{\r\n    value: string;\r\n    contentType?: string;\r\n  }>;\r\n}\r\n\r\nexport class UpdateContactHandler extends BaseToolHandler {\r\n  async runTool(args: UpdateContactArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const people = google.people({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // First, get the existing contact to get the etag\r\n      const existingContact = await people.people.get({\r\n        resourceName: args.resourceName,\r\n        personFields: 'names'\r\n      });\r\n      \r\n      // Build the person object with updates\r\n      const person: people_v1.Schema$Person = {\r\n        etag: existingContact.data.etag,\r\n        resourceName: args.resourceName\r\n      };\r\n      \r\n      // Names\r\n      if (args.updatePersonFields.includes('names')) {\r\n        person.names = [{\r\n          givenName: args.givenName,\r\n          familyName: args.familyName,\r\n          middleName: args.middleName,\r\n          displayName: args.displayName || `${args.givenName || ''} ${args.familyName || ''}`.trim()\r\n        }];\r\n      }\r\n      \r\n      // Email addresses\r\n      if (args.updatePersonFields.includes('emailAddresses') && args.emailAddresses) {\r\n        person.emailAddresses = args.emailAddresses.map(email => ({\r\n          value: email.value,\r\n          type: email.type || 'home'\r\n        }));\r\n      }\r\n      \r\n      // Phone numbers\r\n      if (args.updatePersonFields.includes('phoneNumbers') && args.phoneNumbers) {\r\n        person.phoneNumbers = args.phoneNumbers.map(phone => ({\r\n          value: phone.value,\r\n          type: phone.type || 'home'\r\n        }));\r\n      }\r\n      \r\n      // Addresses\r\n      if (args.updatePersonFields.includes('addresses') && args.addresses) {\r\n        person.addresses = args.addresses.map(address => ({\r\n          streetAddress: address.streetAddress,\r\n          city: address.city,\r\n          region: address.region,\r\n          postalCode: address.postalCode,\r\n          country: address.country,\r\n          type: address.type || 'home'\r\n        }));\r\n      }\r\n      \r\n      // Organizations\r\n      if (args.updatePersonFields.includes('organizations') && args.organizations) {\r\n        person.organizations = args.organizations.map(org => ({\r\n          name: org.name,\r\n          title: org.title,\r\n          department: org.department,\r\n          type: org.type || 'work'\r\n        }));\r\n      }\r\n      \r\n      // Biographies\r\n      if (args.updatePersonFields.includes('biographies') && args.biographies) {\r\n        person.biographies = args.biographies;\r\n      }\r\n      \r\n      const response = await people.people.updateContact({\r\n        resourceName: args.resourceName,\r\n        updatePersonFields: args.updatePersonFields.join(','),\r\n        requestBody: person,\r\n        personFields: 'names,emailAddresses,phoneNumbers,addresses,organizations,biographies'\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              contact: {\r\n                resourceName: response.data.resourceName,\r\n                etag: response.data.etag,\r\n                ...this.formatContactResponse(response.data)\r\n              }\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private formatContactResponse(contact: people_v1.Schema$Person): any {\r\n    return {\r\n      names: contact.names,\r\n      emailAddresses: contact.emailAddresses,\r\n      phoneNumbers: contact.phoneNumbers,\r\n      addresses: contact.addresses,\r\n      organizations: contact.organizations,\r\n      biographies: contact.biographies\r\n    };\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface DeleteContactArgs {\r\n  resourceName: string;\r\n}\r\n\r\nexport class DeleteContactHandler extends BaseToolHandler {\r\n  async runTool(args: DeleteContactArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const people = google.people({ version: 'v1', auth: oauth2Client });\r\n      \r\n      await people.people.deleteContact({\r\n        resourceName: args.resourceName\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              message: `Contact ${args.resourceName} deleted successfully`\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface ListEmailsArgs {\r\n  query?: string;\r\n  maxResults?: number;\r\n  pageToken?: string;\r\n  includeSpamTrash?: boolean;\r\n  labelIds?: string[];\r\n}\r\n\r\nexport class ListEmailsHandler extends BaseToolHandler {\r\n  async runTool(args: ListEmailsArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Build the request parameters\r\n      const params: gmail_v1.Params$Resource$Users$Messages$List = {\r\n        userId: 'me',\r\n        maxResults: args.maxResults || 20,\r\n        includeSpamTrash: args.includeSpamTrash || false,\r\n      };\r\n      \r\n      // Add optional parameters\r\n      if (args.query) {\r\n        params.q = args.query;\r\n      }\r\n      \r\n      if (args.pageToken) {\r\n        params.pageToken = args.pageToken;\r\n      }\r\n      \r\n      if (args.labelIds && args.labelIds.length > 0) {\r\n        params.labelIds = args.labelIds;\r\n      }\r\n      \r\n      // List messages\r\n      const response = await gmail.users.messages.list(params);\r\n      \r\n      const messages = response.data.messages || [];\r\n      \r\n      // Fetch basic info for each message\r\n      const messageDetails = await Promise.all(\r\n        messages.slice(0, 10).map(async (message) => {\r\n          try {\r\n            const details = await gmail.users.messages.get({\r\n              userId: 'me',\r\n              id: message.id!,\r\n              format: 'metadata',\r\n              metadataHeaders: ['From', 'To', 'Subject', 'Date']\r\n            });\r\n            \r\n            return this.formatMessageMetadata(details.data);\r\n          } catch (error) {\r\n            console.error(`Error fetching message ${message.id}:`, error);\r\n            return { id: message.id, error: 'Failed to fetch details' };\r\n          }\r\n        })\r\n      );\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              messages: messageDetails,\r\n              resultSizeEstimate: response.data.resultSizeEstimate,\r\n              nextPageToken: response.data.nextPageToken || null,\r\n              totalMessages: messages.length\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private formatMessageMetadata(message: gmail_v1.Schema$Message): any {\r\n    const headers = message.payload?.headers || [];\r\n    const getHeader = (name: string) => headers.find(h => h.name === name)?.value || '';\r\n    \r\n    return {\r\n      id: message.id,\r\n      threadId: message.threadId,\r\n      subject: getHeader('Subject'),\r\n      from: getHeader('From'),\r\n      to: getHeader('To'),\r\n      date: getHeader('Date'),\r\n      snippet: message.snippet,\r\n      labelIds: message.labelIds || [],\r\n      isUnread: message.labelIds?.includes('UNREAD') || false,\r\n      isImportant: message.labelIds?.includes('IMPORTANT') || false,\r\n      isStarred: message.labelIds?.includes('STARRED') || false,\r\n      hasAttachments: this.hasAttachments(message.payload)\r\n    };\r\n  }\r\n  \r\n  private hasAttachments(payload?: gmail_v1.Schema$MessagePart): boolean {\r\n    if (!payload) return false;\r\n    \r\n    // Check if this part is an attachment\r\n    if (payload.filename && payload.filename.length > 0) {\r\n      return true;\r\n    }\r\n    \r\n    // Recursively check parts\r\n    if (payload.parts) {\r\n      return payload.parts.some(part => this.hasAttachments(part));\r\n    }\r\n    \r\n    return false;\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface GetEmailArgs {\r\n  messageId: string;\r\n  markAsRead?: boolean;\r\n  format?: 'full' | 'metadata' | 'minimal';\r\n}\r\n\r\nexport class GetEmailHandler extends BaseToolHandler {\r\n  async runTool(args: GetEmailArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Get the message\r\n      const response = await gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: args.messageId,\r\n        format: args.format || 'full'\r\n      });\r\n      \r\n      const message = response.data;\r\n      \r\n      // Mark as read if requested (default true unless explicitly false)\r\n      if (args.markAsRead !== false && message.labelIds?.includes('UNREAD')) {\r\n        await gmail.users.messages.modify({\r\n          userId: 'me',\r\n          id: args.messageId,\r\n          requestBody: {\r\n            removeLabelIds: ['UNREAD']\r\n          }\r\n        });\r\n      }\r\n      \r\n      // Format the message based on format type\r\n      const formattedMessage = args.format === 'metadata' \r\n        ? this.formatMessageMetadata(message)\r\n        : this.formatFullMessage(message);\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify(formattedMessage, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private formatMessageMetadata(message: gmail_v1.Schema$Message): any {\r\n    const headers = message.payload?.headers || [];\r\n    const getHeader = (name: string) => headers.find(h => h.name === name)?.value || '';\r\n    \r\n    return {\r\n      id: message.id,\r\n      threadId: message.threadId,\r\n      subject: getHeader('Subject'),\r\n      from: getHeader('From'),\r\n      to: getHeader('To'),\r\n      cc: getHeader('Cc'),\r\n      bcc: getHeader('Bcc'),\r\n      date: getHeader('Date'),\r\n      snippet: message.snippet,\r\n      labelIds: message.labelIds || [],\r\n      sizeEstimate: message.sizeEstimate,\r\n      historyId: message.historyId\r\n    };\r\n  }\r\n\r\n  private formatFullMessage(message: gmail_v1.Schema$Message): any {\r\n    const headers = message.payload?.headers || [];\r\n    const getHeader = (name: string) => headers.find(h => h.name === name)?.value || '';\r\n    \r\n    return {\r\n      id: message.id,\r\n      threadId: message.threadId,\r\n      labelIds: message.labelIds || [],\r\n      snippet: message.snippet,\r\n      historyId: message.historyId,\r\n      internalDate: message.internalDate,\r\n      sizeEstimate: message.sizeEstimate,\r\n      headers: {\r\n        subject: getHeader('Subject'),\r\n        from: getHeader('From'),\r\n        to: getHeader('To'),\r\n        cc: getHeader('Cc'),\r\n        bcc: getHeader('Bcc'),\r\n        date: getHeader('Date'),\r\n        messageId: getHeader('Message-ID'),\r\n        inReplyTo: getHeader('In-Reply-To'),\r\n        references: getHeader('References')\r\n      },\r\n      body: this.extractBody(message.payload),\r\n      attachments: this.extractAttachments(message.payload),\r\n      isUnread: message.labelIds?.includes('UNREAD') || false,\r\n      isImportant: message.labelIds?.includes('IMPORTANT') || false,\r\n      isStarred: message.labelIds?.includes('STARRED') || false,\r\n      isDraft: message.labelIds?.includes('DRAFT') || false\r\n    };\r\n  }\r\n\r\n  private extractBody(payload?: gmail_v1.Schema$MessagePart): { text?: string; html?: string } {\r\n    if (!payload) return {};\r\n    \r\n    const result: { text?: string; html?: string } = {};\r\n    \r\n    // Direct body\r\n    if (payload.body?.data) {\r\n      const decoded = Buffer.from(payload.body.data, 'base64').toString('utf-8');\r\n      if (payload.mimeType === 'text/plain') {\r\n        result.text = decoded;\r\n      } else if (payload.mimeType === 'text/html') {\r\n        result.html = decoded;\r\n      }\r\n    }\r\n    \r\n    // Process parts\r\n    if (payload.parts) {\r\n      for (const part of payload.parts) {\r\n        if (part.mimeType === 'text/plain' && part.body?.data) {\r\n          result.text = Buffer.from(part.body.data, 'base64').toString('utf-8');\r\n        } else if (part.mimeType === 'text/html' && part.body?.data) {\r\n          result.html = Buffer.from(part.body.data, 'base64').toString('utf-8');\r\n        } else if (part.mimeType?.startsWith('multipart/')) {\r\n          // Recursively process multipart\r\n          const nestedBody = this.extractBody(part);\r\n          if (nestedBody.text) result.text = nestedBody.text;\r\n          if (nestedBody.html) result.html = nestedBody.html;\r\n        }\r\n      }\r\n    }\r\n    \r\n    return result;\r\n  }\r\n\r\n  private extractAttachments(payload?: gmail_v1.Schema$MessagePart): any[] {\r\n    if (!payload) return [];\r\n    \r\n    const attachments: any[] = [];\r\n    \r\n    const processPartForAttachments = (part: gmail_v1.Schema$MessagePart) => {\r\n      if (part.filename && part.filename.length > 0) {\r\n        attachments.push({\r\n          filename: part.filename,\r\n          mimeType: part.mimeType,\r\n          size: part.body?.size || 0,\r\n          attachmentId: part.body?.attachmentId\r\n        });\r\n      }\r\n      \r\n      if (part.parts) {\r\n        part.parts.forEach(processPartForAttachments);\r\n      }\r\n    };\r\n    \r\n    processPartForAttachments(payload);\r\n    return attachments;\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface SendEmailArgs {\r\n  to: string | string[];\r\n  subject: string;\r\n  body: string;\r\n  cc?: string | string[];\r\n  bcc?: string | string[];\r\n  isHtml?: boolean;\r\n  replyToMessageId?: string;\r\n  threadId?: string;\r\n}\r\n\r\nexport class SendEmailHandler extends BaseToolHandler {\r\n  async runTool(args: SendEmailArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Get user's email address\r\n      const profile = await gmail.users.getProfile({ userId: 'me' });\r\n      const userEmail = profile.data.emailAddress;\r\n      \r\n      // Create the email message\r\n      const message = this.createMessage(\r\n        userEmail!,\r\n        args.to,\r\n        args.subject,\r\n        args.body,\r\n        args.cc,\r\n        args.bcc,\r\n        args.isHtml || false,\r\n        args.replyToMessageId\r\n      );\r\n      \r\n      // Create the request body\r\n      const requestBody: gmail_v1.Schema$Message = {\r\n        raw: message\r\n      };\r\n      \r\n      // If replying to a thread, include the threadId\r\n      if (args.threadId) {\r\n        requestBody.threadId = args.threadId;\r\n      }\r\n      \r\n      // Send the message\r\n      const response = await gmail.users.messages.send({\r\n        userId: 'me',\r\n        requestBody\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              messageId: response.data.id,\r\n              threadId: response.data.threadId,\r\n              labelIds: response.data.labelIds\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private createMessage(\r\n    from: string,\r\n    to: string | string[],\r\n    subject: string,\r\n    body: string,\r\n    cc?: string | string[],\r\n    bcc?: string | string[],\r\n    isHtml: boolean = false,\r\n    replyToMessageId?: string\r\n  ): string {\r\n    const boundary = \"boundary_\" + Date.now();\r\n    const toAddresses = Array.isArray(to) ? to.join(', ') : to;\r\n    \r\n    let messageParts = [\r\n      `From: ${from}`,\r\n      `To: ${toAddresses}`,\r\n      `Subject: ${subject}`,\r\n      'MIME-Version: 1.0'\r\n    ];\r\n    \r\n    // Add CC if provided\r\n    if (cc) {\r\n      const ccAddresses = Array.isArray(cc) ? cc.join(', ') : cc;\r\n      messageParts.push(`Cc: ${ccAddresses}`);\r\n    }\r\n    \r\n    // Add BCC if provided\r\n    if (bcc) {\r\n      const bccAddresses = Array.isArray(bcc) ? bcc.join(', ') : bcc;\r\n      messageParts.push(`Bcc: ${bccAddresses}`);\r\n    }\r\n    \r\n    // Add In-Reply-To header if replying\r\n    if (replyToMessageId) {\r\n      messageParts.push(`In-Reply-To: ${replyToMessageId}`);\r\n      messageParts.push(`References: ${replyToMessageId}`);\r\n    }\r\n    \r\n    // Set content type\r\n    if (isHtml) {\r\n      messageParts.push(`Content-Type: multipart/alternative; boundary=\"${boundary}\"`);\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}`);\r\n      messageParts.push('Content-Type: text/plain; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(this.htmlToText(body));\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}`);\r\n      messageParts.push('Content-Type: text/html; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(body);\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}--`);\r\n    } else {\r\n      messageParts.push('Content-Type: text/plain; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(body);\r\n    }\r\n    \r\n    const message = messageParts.join('\\r\\n');\r\n    \r\n    // Encode in base64\r\n    const encodedMessage = Buffer.from(message)\r\n      .toString('base64')\r\n      .replace(/\\+/g, '-')\r\n      .replace(/\\//g, '_')\r\n      .replace(/=+$/, '');\r\n    \r\n    return encodedMessage;\r\n  }\r\n  \r\n  private htmlToText(html: string): string {\r\n    // Simple HTML to text conversion\r\n    return html\r\n      .replace(/<br\\s*\\/?>/gi, '\\n')\r\n      .replace(/<\\/p>/gi, '\\n\\n')\r\n      .replace(/<[^>]+>/g, '')\r\n      .replace(/&nbsp;/g, ' ')\r\n      .replace(/&amp;/g, '&')\r\n      .replace(/&lt;/g, '<')\r\n      .replace(/&gt;/g, '>')\r\n      .replace(/&quot;/g, '\"')\r\n      .replace(/&#39;/g, \"'\")\r\n      .trim();\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\nimport { LabelMutationBuilder, LabelMutationFlags } from \"./utils/labelMutationBuilder.js\";\r\n\r\ninterface UpdateEmailArgs extends LabelMutationFlags {\r\n  messageId: string;\r\n  moveToTrash?: boolean;\r\n  removeFromTrash?: boolean;\r\n}\r\n\r\nexport class UpdateEmailHandler extends BaseToolHandler {\r\n  async runTool(args: UpdateEmailArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Handle trash operations separately\r\n      if (args.moveToTrash) {\r\n        await gmail.users.messages.trash({\r\n          userId: 'me',\r\n          id: args.messageId\r\n        });\r\n        \r\n        return {\r\n          content: [\r\n            {\r\n              type: \"text\",\r\n              text: JSON.stringify({\r\n                success: true,\r\n                messageId: args.messageId,\r\n                action: 'moved_to_trash'\r\n              }, null, 2)\r\n            }\r\n          ]\r\n        };\r\n      }\r\n      \r\n      if (args.removeFromTrash) {\r\n        await gmail.users.messages.untrash({\r\n          userId: 'me',\r\n          id: args.messageId\r\n        });\r\n        \r\n        return {\r\n          content: [\r\n            {\r\n              type: \"text\",\r\n              text: JSON.stringify({\r\n                success: true,\r\n                messageId: args.messageId,\r\n                action: 'removed_from_trash'\r\n              }, null, 2)\r\n            }\r\n          ]\r\n        };\r\n      }\r\n      \r\n      // Build label mutations with validation\r\n      const mutation = LabelMutationBuilder.build(args);\r\n      \r\n      // Check if there are any changes to make\r\n      if (mutation.addLabelIds.length === 0 && mutation.removeLabelIds.length === 0) {\r\n        return {\r\n          content: [\r\n            {\r\n              type: \"text\",\r\n              text: JSON.stringify({\r\n                success: true,\r\n                messageId: args.messageId,\r\n                message: 'No changes were made'\r\n              }, null, 2)\r\n            }\r\n          ]\r\n        };\r\n      }\r\n      \r\n      // Check if message can be modified (TRASH/SPAM restrictions)\r\n      const preCheck = await gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: args.messageId,\r\n        format: 'minimal'\r\n      });\r\n      \r\n      const currentLabels = preCheck.data.labelIds || [];\r\n      \r\n      if (!LabelMutationBuilder.canModifyLabels(currentLabels, mutation)) {\r\n        return {\r\n          content: [\r\n            {\r\n              type: \"text\",\r\n              text: JSON.stringify({\r\n                success: false,\r\n                messageId: args.messageId,\r\n                error: 'Cannot modify labels on messages in TRASH or SPAM folders',\r\n                currentLabels: currentLabels\r\n              }, null, 2)\r\n            }\r\n          ]\r\n        };\r\n      }\r\n      \r\n      console.log('UpdateEmail - Calling modify with:', {\r\n        messageId: args.messageId,\r\n        addLabelIds: mutation.addLabelIds,\r\n        removeLabelIds: mutation.removeLabelIds\r\n      });\r\n      \r\n      const response = await gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: args.messageId,\r\n        requestBody: {\r\n          addLabelIds: mutation.addLabelIds,\r\n          removeLabelIds: mutation.removeLabelIds\r\n        }\r\n      });\r\n      \r\n      console.log('UpdateEmail - API response:', response.status, response.statusText);\r\n      \r\n      // Verify the change took effect\r\n      await new Promise(resolve => setTimeout(resolve, 100));\r\n      \r\n      const postCheck = await gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: args.messageId,\r\n        format: 'minimal'\r\n      });\r\n      \r\n      const finalLabels = postCheck.data.labelIds || [];\r\n      \r\n      // Verify changes were applied\r\n      const expectedAdded = mutation.addLabelIds.every(label => \r\n        finalLabels.includes(label)\r\n      );\r\n      const expectedRemoved = mutation.removeLabelIds.every(label => \r\n        !finalLabels.includes(label)\r\n      );\r\n      \r\n      const verified = expectedAdded && expectedRemoved;\r\n      \r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: verified,\r\n              messageId: response.data.id,\r\n              threadId: response.data.threadId,\r\n              labelIds: finalLabels,\r\n              addedLabels: mutation.addLabelIds,\r\n              removedLabels: mutation.removeLabelIds,\r\n              verified: verified,\r\n              warning: verified ? undefined : 'Changes may not have been fully applied'\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error: any) {\r\n      console.error('UpdateEmail - Error details:', {\r\n        message: error.message,\r\n        code: error.code,\r\n        errors: error.errors,\r\n        response: error.response?.data\r\n      });\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n}", "/**\r\n * Shared utility for building label mutations from convenience flags\r\n */\r\n\r\nexport interface LabelMutationFlags {\r\n  addLabelIds?: string[];\r\n  removeLabelIds?: string[];\r\n  markAsRead?: boolean;\r\n  markAsUnread?: boolean;\r\n  star?: boolean;\r\n  unstar?: boolean;\r\n  markAsImportant?: boolean;\r\n  markAsNotImportant?: boolean;\r\n  archive?: boolean;\r\n  unarchive?: boolean;\r\n}\r\n\r\nexport interface LabelMutation {\r\n  addLabelIds: string[];\r\n  removeLabelIds: string[];\r\n}\r\n\r\nexport class LabelMutationBuilder {\r\n  /**\r\n   * Validates mutually exclusive flags\r\n   */\r\n  static validate(flags: LabelMutationFlags): void {\r\n    const conflicts: Array<[string, string]> = [\r\n      ['markAsRead', 'markAsUnread'],\r\n      ['star', 'unstar'],\r\n      ['markAsImportant', 'markAsNotImportant'],\r\n      ['archive', 'unarchive']\r\n    ];\r\n\r\n    for (const [flag1, flag2] of conflicts) {\r\n      if (flags[flag1 as keyof LabelMutationFlags] && flags[flag2 as keyof LabelMutationFlags]) {\r\n        throw new Error(`Conflicting flags: cannot set both ${flag1} and ${flag2}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Builds label mutations from convenience flags\r\n   */\r\n  static build(flags: LabelMutationFlags): LabelMutation {\r\n    // Validate first\r\n    this.validate(flags);\r\n\r\n    const addLabelIds: string[] = [...(flags.addLabelIds || [])];\r\n    const removeLabelIds: string[] = [...(flags.removeLabelIds || [])];\r\n\r\n    // Handle convenience flags\r\n    if (flags.markAsRead) {\r\n      removeLabelIds.push('UNREAD');\r\n    }\r\n    if (flags.markAsUnread) {\r\n      addLabelIds.push('UNREAD');\r\n    }\r\n    if (flags.star) {\r\n      addLabelIds.push('STARRED');\r\n    }\r\n    if (flags.unstar) {\r\n      removeLabelIds.push('STARRED');\r\n    }\r\n    if (flags.markAsImportant) {\r\n      addLabelIds.push('IMPORTANT');\r\n    }\r\n    if (flags.markAsNotImportant) {\r\n      removeLabelIds.push('IMPORTANT');\r\n    }\r\n    if (flags.archive) {\r\n      removeLabelIds.push('INBOX');\r\n    }\r\n    if (flags.unarchive) {\r\n      addLabelIds.push('INBOX');\r\n    }\r\n\r\n    // Remove duplicates\r\n    const uniqueAddLabelIds = [...new Set(addLabelIds)];\r\n    const uniqueRemoveLabelIds = [...new Set(removeLabelIds)];\r\n\r\n    // Remove any labels that appear in both lists\r\n    const finalAddLabelIds = uniqueAddLabelIds.filter(id => !uniqueRemoveLabelIds.includes(id));\r\n    const finalRemoveLabelIds = uniqueRemoveLabelIds.filter(id => !uniqueAddLabelIds.includes(id));\r\n\r\n    return {\r\n      addLabelIds: finalAddLabelIds,\r\n      removeLabelIds: finalRemoveLabelIds\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Checks if a message can have its labels modified based on its current labels\r\n   * Gmail blocks most label operations on TRASH/SPAM messages\r\n   */\r\n  static canModifyLabels(currentLabels: string[], mutation: LabelMutation): boolean {\r\n    const isInTrash = currentLabels.includes('TRASH');\r\n    const isInSpam = currentLabels.includes('SPAM');\r\n    \r\n    // If in TRASH or SPAM, only untrash/unspam operations are allowed\r\n    if (isInTrash || isInSpam) {\r\n      // Check if trying to remove TRASH or SPAM (untrash/unspam)\r\n      const removingTrash = mutation.removeLabelIds.includes('TRASH');\r\n      const removingSpam = mutation.removeLabelIds.includes('SPAM');\r\n      \r\n      // If only removing TRASH/SPAM, that's allowed\r\n      if (removingTrash || removingSpam) {\r\n        return true;\r\n      }\r\n      \r\n      // Any other label operation on TRASH/SPAM is blocked\r\n      return false;\r\n    }\r\n    \r\n    return true;\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface DeleteEmailArgs {\r\n  messageId: string;\r\n  permanent?: boolean;\r\n}\r\n\r\nexport class DeleteEmailHandler extends BaseToolHandler {\r\n  async runTool(args: DeleteEmailArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      if (args.permanent) {\r\n        // Permanently delete the message\r\n        await gmail.users.messages.delete({\r\n          userId: 'me',\r\n          id: args.messageId\r\n        });\r\n        \r\n        return {\r\n          content: [\r\n            {\r\n              type: \"text\",\r\n              text: JSON.stringify({\r\n                success: true,\r\n                messageId: args.messageId,\r\n                action: 'permanently_deleted',\r\n                warning: 'This action cannot be undone'\r\n              }, null, 2)\r\n            }\r\n          ]\r\n        };\r\n      } else {\r\n        // Move to trash (default behavior)\r\n        await gmail.users.messages.trash({\r\n          userId: 'me',\r\n          id: args.messageId\r\n        });\r\n        \r\n        return {\r\n          content: [\r\n            {\r\n              type: \"text\",\r\n              text: JSON.stringify({\r\n                success: true,\r\n                messageId: args.messageId,\r\n                action: 'moved_to_trash',\r\n                note: 'Email moved to trash. Use permanent=true to permanently delete.'\r\n              }, null, 2)\r\n            }\r\n          ]\r\n        };\r\n      }\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface CreateDraftArgs {\r\n  to: string | string[];\r\n  subject: string;\r\n  body: string;\r\n  cc?: string | string[];\r\n  bcc?: string | string[];\r\n  isHtml?: boolean;\r\n  replyToMessageId?: string;\r\n  threadId?: string;\r\n}\r\n\r\nexport class CreateDraftHandler extends BaseToolHandler {\r\n  async runTool(args: CreateDraftArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Get user's email address\r\n      const profile = await gmail.users.getProfile({ userId: 'me' });\r\n      const userEmail = profile.data.emailAddress;\r\n      \r\n      // Create the email message\r\n      const message = this.createMessage(\r\n        userEmail!,\r\n        args.to,\r\n        args.subject,\r\n        args.body,\r\n        args.cc,\r\n        args.bcc,\r\n        args.isHtml || false,\r\n        args.replyToMessageId\r\n      );\r\n      \r\n      // Create the draft\r\n      const requestBody: gmail_v1.Schema$Draft = {\r\n        message: {\r\n          raw: message,\r\n          threadId: args.threadId\r\n        }\r\n      };\r\n      \r\n      const response = await gmail.users.drafts.create({\r\n        userId: 'me',\r\n        requestBody\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              draftId: response.data.id,\r\n              messageId: response.data.message?.id,\r\n              threadId: response.data.message?.threadId\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private createMessage(\r\n    from: string,\r\n    to: string | string[],\r\n    subject: string,\r\n    body: string,\r\n    cc?: string | string[],\r\n    bcc?: string | string[],\r\n    isHtml: boolean = false,\r\n    replyToMessageId?: string\r\n  ): string {\r\n    const boundary = \"boundary_\" + Date.now();\r\n    const toAddresses = Array.isArray(to) ? to.join(', ') : to;\r\n    \r\n    let messageParts = [\r\n      `From: ${from}`,\r\n      `To: ${toAddresses}`,\r\n      `Subject: ${subject}`,\r\n      'MIME-Version: 1.0'\r\n    ];\r\n    \r\n    // Add CC if provided\r\n    if (cc) {\r\n      const ccAddresses = Array.isArray(cc) ? cc.join(', ') : cc;\r\n      messageParts.push(`Cc: ${ccAddresses}`);\r\n    }\r\n    \r\n    // Add BCC if provided\r\n    if (bcc) {\r\n      const bccAddresses = Array.isArray(bcc) ? bcc.join(', ') : bcc;\r\n      messageParts.push(`Bcc: ${bccAddresses}`);\r\n    }\r\n    \r\n    // Add In-Reply-To header if replying\r\n    if (replyToMessageId) {\r\n      messageParts.push(`In-Reply-To: ${replyToMessageId}`);\r\n      messageParts.push(`References: ${replyToMessageId}`);\r\n    }\r\n    \r\n    // Set content type\r\n    if (isHtml) {\r\n      messageParts.push(`Content-Type: multipart/alternative; boundary=\"${boundary}\"`);\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}`);\r\n      messageParts.push('Content-Type: text/plain; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(this.htmlToText(body));\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}`);\r\n      messageParts.push('Content-Type: text/html; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(body);\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}--`);\r\n    } else {\r\n      messageParts.push('Content-Type: text/plain; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(body);\r\n    }\r\n    \r\n    const message = messageParts.join('\\r\\n');\r\n    \r\n    // Encode in base64\r\n    const encodedMessage = Buffer.from(message)\r\n      .toString('base64')\r\n      .replace(/\\+/g, '-')\r\n      .replace(/\\//g, '_')\r\n      .replace(/=+$/, '');\r\n    \r\n    return encodedMessage;\r\n  }\r\n  \r\n  private htmlToText(html: string): string {\r\n    // Simple HTML to text conversion\r\n    return html\r\n      .replace(/<br\\s*\\/?>/gi, '\\n')\r\n      .replace(/<\\/p>/gi, '\\n\\n')\r\n      .replace(/<[^>]+>/g, '')\r\n      .replace(/&nbsp;/g, ' ')\r\n      .replace(/&amp;/g, '&')\r\n      .replace(/&lt;/g, '<')\r\n      .replace(/&gt;/g, '>')\r\n      .replace(/&quot;/g, '\"')\r\n      .replace(/&#39;/g, \"'\")\r\n      .trim();\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface UpdateDraftArgs {\r\n  draftId: string;\r\n  to: string | string[];\r\n  subject: string;\r\n  body: string;\r\n  cc?: string | string[];\r\n  bcc?: string | string[];\r\n  isHtml?: boolean;\r\n  replyToMessageId?: string;\r\n  threadId?: string;\r\n}\r\n\r\nexport class UpdateDraftHandler extends BaseToolHandler {\r\n  async runTool(args: UpdateDraftArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Get user's email address\r\n      const profile = await gmail.users.getProfile({ userId: 'me' });\r\n      const userEmail = profile.data.emailAddress;\r\n      \r\n      // Create the updated email message\r\n      const message = this.createMessage(\r\n        userEmail!,\r\n        args.to,\r\n        args.subject,\r\n        args.body,\r\n        args.cc,\r\n        args.bcc,\r\n        args.isHtml || false,\r\n        args.replyToMessageId\r\n      );\r\n      \r\n      // Update the draft\r\n      const requestBody: gmail_v1.Schema$Draft = {\r\n        message: {\r\n          raw: message,\r\n          threadId: args.threadId\r\n        }\r\n      };\r\n      \r\n      const response = await gmail.users.drafts.update({\r\n        userId: 'me',\r\n        id: args.draftId,\r\n        requestBody\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              draftId: response.data.id,\r\n              messageId: response.data.message?.id,\r\n              threadId: response.data.message?.threadId\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private createMessage(\r\n    from: string,\r\n    to: string | string[],\r\n    subject: string,\r\n    body: string,\r\n    cc?: string | string[],\r\n    bcc?: string | string[],\r\n    isHtml: boolean = false,\r\n    replyToMessageId?: string\r\n  ): string {\r\n    const boundary = \"boundary_\" + Date.now();\r\n    const toAddresses = Array.isArray(to) ? to.join(', ') : to;\r\n    \r\n    let messageParts = [\r\n      `From: ${from}`,\r\n      `To: ${toAddresses}`,\r\n      `Subject: ${subject}`,\r\n      'MIME-Version: 1.0'\r\n    ];\r\n    \r\n    // Add CC if provided\r\n    if (cc) {\r\n      const ccAddresses = Array.isArray(cc) ? cc.join(', ') : cc;\r\n      messageParts.push(`Cc: ${ccAddresses}`);\r\n    }\r\n    \r\n    // Add BCC if provided\r\n    if (bcc) {\r\n      const bccAddresses = Array.isArray(bcc) ? bcc.join(', ') : bcc;\r\n      messageParts.push(`Bcc: ${bccAddresses}`);\r\n    }\r\n    \r\n    // Add In-Reply-To header if replying\r\n    if (replyToMessageId) {\r\n      messageParts.push(`In-Reply-To: ${replyToMessageId}`);\r\n      messageParts.push(`References: ${replyToMessageId}`);\r\n    }\r\n    \r\n    // Set content type\r\n    if (isHtml) {\r\n      messageParts.push(`Content-Type: multipart/alternative; boundary=\"${boundary}\"`);\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}`);\r\n      messageParts.push('Content-Type: text/plain; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(this.htmlToText(body));\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}`);\r\n      messageParts.push('Content-Type: text/html; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(body);\r\n      messageParts.push('');\r\n      messageParts.push(`--${boundary}--`);\r\n    } else {\r\n      messageParts.push('Content-Type: text/plain; charset=UTF-8');\r\n      messageParts.push('');\r\n      messageParts.push(body);\r\n    }\r\n    \r\n    const message = messageParts.join('\\r\\n');\r\n    \r\n    // Encode in base64\r\n    const encodedMessage = Buffer.from(message)\r\n      .toString('base64')\r\n      .replace(/\\+/g, '-')\r\n      .replace(/\\//g, '_')\r\n      .replace(/=+$/, '');\r\n    \r\n    return encodedMessage;\r\n  }\r\n  \r\n  private htmlToText(html: string): string {\r\n    // Simple HTML to text conversion\r\n    return html\r\n      .replace(/<br\\s*\\/?>/gi, '\\n')\r\n      .replace(/<\\/p>/gi, '\\n\\n')\r\n      .replace(/<[^>]+>/g, '')\r\n      .replace(/&nbsp;/g, ' ')\r\n      .replace(/&amp;/g, '&')\r\n      .replace(/&lt;/g, '<')\r\n      .replace(/&gt;/g, '>')\r\n      .replace(/&quot;/g, '\"')\r\n      .replace(/&#39;/g, \"'\")\r\n      .trim();\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface SendDraftArgs {\r\n  draftId: string;\r\n}\r\n\r\nexport class SendDraftHandler extends BaseToolHandler {\r\n  async runTool(args: SendDraftArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Send the draft\r\n      const response = await gmail.users.drafts.send({\r\n        userId: 'me',\r\n        requestBody: {\r\n          id: args.draftId\r\n        }\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              messageId: response.data.id,\r\n              threadId: response.data.threadId,\r\n              labelIds: response.data.labelIds\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\nexport class ListLabelsHandler extends BaseToolHandler {\r\n  async runTool(args: any, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // List all labels\r\n      const response = await gmail.users.labels.list({\r\n        userId: 'me'\r\n      });\r\n      \r\n      const labels = response.data.labels || [];\r\n      \r\n      // Separate system and user labels\r\n      const systemLabels = labels.filter(label => label.type === 'system');\r\n      const userLabels = labels.filter(label => label.type === 'user');\r\n      \r\n      // Format labels for better readability\r\n      const formattedLabels = {\r\n        systemLabels: systemLabels.map(this.formatLabel),\r\n        userLabels: userLabels.map(this.formatLabel),\r\n        totalCount: labels.length,\r\n        systemCount: systemLabels.length,\r\n        userCount: userLabels.length\r\n      };\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify(formattedLabels, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private formatLabel(label: any): any {\r\n    return {\r\n      id: label.id,\r\n      name: label.name,\r\n      type: label.type,\r\n      messageListVisibility: label.messageListVisibility,\r\n      labelListVisibility: label.labelListVisibility,\r\n      color: label.color ? {\r\n        textColor: label.color.textColor,\r\n        backgroundColor: label.color.backgroundColor\r\n      } : undefined,\r\n      messagesTotal: label.messagesTotal,\r\n      messagesUnread: label.messagesUnread,\r\n      threadsTotal: label.threadsTotal,\r\n      threadsUnread: label.threadsUnread\r\n    };\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface CreateLabelArgs {\r\n  name: string;\r\n  messageListVisibility?: 'show' | 'hide';\r\n  labelListVisibility?: 'labelShow' | 'labelShowIfUnread' | 'labelHide';\r\n  backgroundColor?: string;\r\n  textColor?: string;\r\n}\r\n\r\nexport class CreateLabelHandler extends BaseToolHandler {\r\n  async runTool(args: CreateLabelArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Build the label object\r\n      const requestBody: gmail_v1.Schema$Label = {\r\n        name: args.name,\r\n        messageListVisibility: args.messageListVisibility || 'show',\r\n        labelListVisibility: args.labelListVisibility || 'labelShow'\r\n      };\r\n      \r\n      // Add color if provided\r\n      if (args.backgroundColor || args.textColor) {\r\n        requestBody.color = {\r\n          backgroundColor: args.backgroundColor,\r\n          textColor: args.textColor\r\n        };\r\n      }\r\n      \r\n      // Create the label\r\n      const response = await gmail.users.labels.create({\r\n        userId: 'me',\r\n        requestBody\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              label: {\r\n                id: response.data.id,\r\n                name: response.data.name,\r\n                type: response.data.type,\r\n                messageListVisibility: response.data.messageListVisibility,\r\n                labelListVisibility: response.data.labelListVisibility,\r\n                color: response.data.color\r\n              }\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface UpdateLabelArgs {\r\n  labelId: string;\r\n  name?: string;\r\n  messageListVisibility?: 'show' | 'hide';\r\n  labelListVisibility?: 'labelShow' | 'labelShowIfUnread' | 'labelHide';\r\n  backgroundColor?: string;\r\n  textColor?: string;\r\n}\r\n\r\nexport class UpdateLabelHandler extends BaseToolHandler {\r\n  async runTool(args: UpdateLabelArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Build the update object\r\n      const requestBody: gmail_v1.Schema$Label = {};\r\n      \r\n      if (args.name) {\r\n        requestBody.name = args.name;\r\n      }\r\n      \r\n      if (args.messageListVisibility) {\r\n        requestBody.messageListVisibility = args.messageListVisibility;\r\n      }\r\n      \r\n      if (args.labelListVisibility) {\r\n        requestBody.labelListVisibility = args.labelListVisibility;\r\n      }\r\n      \r\n      // Add color if provided\r\n      if (args.backgroundColor || args.textColor) {\r\n        requestBody.color = {\r\n          backgroundColor: args.backgroundColor,\r\n          textColor: args.textColor\r\n        };\r\n      }\r\n      \r\n      // Update the label (using patch for partial updates)\r\n      const response = await gmail.users.labels.patch({\r\n        userId: 'me',\r\n        id: args.labelId,\r\n        requestBody\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              label: {\r\n                id: response.data.id,\r\n                name: response.data.name,\r\n                type: response.data.type,\r\n                messageListVisibility: response.data.messageListVisibility,\r\n                labelListVisibility: response.data.labelListVisibility,\r\n                color: response.data.color,\r\n                messagesTotal: response.data.messagesTotal,\r\n                messagesUnread: response.data.messagesUnread,\r\n                threadsTotal: response.data.threadsTotal,\r\n                threadsUnread: response.data.threadsUnread\r\n              }\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\n\r\ninterface DeleteLabelArgs {\r\n  labelId: string;\r\n}\r\n\r\nexport class DeleteLabelHandler extends BaseToolHandler {\r\n  async runTool(args: DeleteLabelArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Delete the label\r\n      await gmail.users.labels.delete({\r\n        userId: 'me',\r\n        id: args.labelId\r\n      });\r\n\r\n      return {\r\n        content: [\r\n          {\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              message: `Label ${args.labelId} deleted successfully`,\r\n              warning: 'This action removed the label from all messages and threads'\r\n            }, null, 2)\r\n          }\r\n        ]\r\n      };\r\n    } catch (error) {\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n}", "import { CallToolResult } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from \"google-auth-library\";\r\nimport { google, gmail_v1 } from \"googleapis\";\r\nimport { BaseToolHandler } from \"../BaseToolHandler.js\";\r\nimport { LabelMutationBuilder, LabelMutationFlags } from \"./utils/labelMutationBuilder.js\";\r\nimport { GmailRateLimiter } from \"./utils/rateLimiter.js\";\r\n\r\ninterface BatchUpdateEmailsArgs extends LabelMutationFlags {\r\n  messageIds: string[];\r\n  moveToTrash?: boolean;\r\n}\r\n\r\ninterface MessageVerification {\r\n  id: string;\r\n  success: boolean;\r\n  preLabels?: string[];\r\n  postLabels?: string[];\r\n  error?: string;\r\n  skippedReason?: string;\r\n}\r\n\r\nexport class BatchUpdateEmailsHandler extends BaseToolHandler {\r\n  private static readonly CHUNK_SIZE = 50; // Gmail recommends max 50 for batch operations\r\n  private static readonly PARALLEL_VERIFY_LIMIT = 20; // Concurrent verification requests\r\n  \r\n  async runTool(args: BatchUpdateEmailsArgs, oauth2Client: OAuth2Client): Promise<CallToolResult> {\r\n    try {\r\n      // Early validation: empty array\r\n      if (!args.messageIds || args.messageIds.length === 0) {\r\n        return {\r\n          content: [{\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              message: 'No message IDs provided',\r\n              messageCount: 0\r\n            }, null, 2)\r\n          }]\r\n        };\r\n      }\r\n\r\n      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });\r\n      \r\n      // Handle trash operation separately (uses batchDelete)\r\n      if (args.moveToTrash) {\r\n        return this.handleBatchTrash(gmail, args.messageIds);\r\n      }\r\n      \r\n      // Build label mutations with validation\r\n      const mutation = LabelMutationBuilder.build(args);\r\n      \r\n      // Check if there are any changes to make\r\n      if (mutation.addLabelIds.length === 0 && mutation.removeLabelIds.length === 0) {\r\n        return {\r\n          content: [{\r\n            type: \"text\",\r\n            text: JSON.stringify({\r\n              success: true,\r\n              message: 'No label changes requested',\r\n              messageCount: args.messageIds.length\r\n            }, null, 2)\r\n          }]\r\n        };\r\n      }\r\n\r\n      console.log('BatchUpdateEmails - Starting operation:', {\r\n        totalMessages: args.messageIds.length,\r\n        addLabelIds: mutation.addLabelIds,\r\n        removeLabelIds: mutation.removeLabelIds\r\n      });\r\n      \r\n      // Process messages with verification and retry\r\n      const results = await this.processMessagesWithVerification(\r\n        gmail,\r\n        args.messageIds,\r\n        mutation\r\n      );\r\n      \r\n      // Calculate final statistics\r\n      const successful = results.filter(r => r.success);\r\n      const failed = results.filter(r => !r.success);\r\n      \r\n      console.log('BatchUpdateEmails - Final summary:', {\r\n        total: args.messageIds.length,\r\n        successful: successful.length,\r\n        failed: failed.length\r\n      });\r\n      \r\n      return {\r\n        content: [{\r\n          type: \"text\",\r\n          text: JSON.stringify({\r\n            success: failed.length === 0,\r\n            action: 'batch_modified',\r\n            summary: {\r\n              total: args.messageIds.length,\r\n              successful: successful.length,\r\n              failed: failed.length\r\n            },\r\n            details: {\r\n              successfulIds: successful.map(r => r.id),\r\n              failedOperations: failed.map(r => ({\r\n                id: r.id,\r\n                reason: r.error || r.skippedReason || 'Unknown error'\r\n              })),\r\n              addedLabels: mutation.addLabelIds,\r\n              removedLabels: mutation.removeLabelIds\r\n            }\r\n          }, null, 2)\r\n        }]\r\n      };\r\n    } catch (error: any) {\r\n      console.error('BatchUpdateEmails - Fatal error:', {\r\n        message: error.message,\r\n        code: error.code,\r\n        errors: error.errors,\r\n        response: error.response?.data\r\n      });\r\n      this.handleGoogleApiError(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async handleBatchTrash(\r\n    gmail: gmail_v1.Gmail,\r\n    messageIds: string[]\r\n  ): Promise<CallToolResult> {\r\n    try {\r\n      // Process in chunks for batchDelete\r\n      const chunks = this.chunkArray(messageIds, 1000); // batchDelete supports up to 1000\r\n      \r\n      for (const chunk of chunks) {\r\n        await gmail.users.messages.batchDelete({\r\n          userId: 'me',\r\n          requestBody: {\r\n            ids: chunk\r\n          }\r\n        });\r\n      }\r\n      \r\n      return {\r\n        content: [{\r\n          type: \"text\",\r\n          text: JSON.stringify({\r\n            success: true,\r\n            action: 'batch_moved_to_trash',\r\n            messageCount: messageIds.length,\r\n            messageIds: messageIds\r\n          }, null, 2)\r\n        }]\r\n      };\r\n    } catch (error: any) {\r\n      // batchDelete might partially succeed\r\n      console.error('BatchUpdateEmails - Trash operation failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async processMessagesWithVerification(\r\n    gmail: gmail_v1.Gmail,\r\n    messageIds: string[],\r\n    mutation: { addLabelIds: string[]; removeLabelIds: string[] }\r\n  ): Promise<MessageVerification[]> {\r\n    const rateLimiter = new GmailRateLimiter();\r\n    const chunks = this.chunkArray(messageIds, BatchUpdateEmailsHandler.CHUNK_SIZE);\r\n    const allResults: MessageVerification[] = [];\r\n    \r\n    for (let i = 0; i < chunks.length; i++) {\r\n      const chunk = chunks[i];\r\n      const chunkIndex = i + 1;\r\n      const totalChunks = chunks.length;\r\n      \r\n      console.log(`BatchUpdateEmails - Processing chunk ${chunkIndex}/${totalChunks} (${chunk.length} messages)`);\r\n      \r\n      // Add delay based on rate limiting\r\n      if (i > 0) {\r\n        await rateLimiter.wait();\r\n      }\r\n      \r\n      try {\r\n        // Execute batch modify\r\n        const response = await gmail.users.messages.batchModify({\r\n          userId: 'me',\r\n          requestBody: {\r\n            ids: chunk,\r\n            addLabelIds: mutation.addLabelIds,\r\n            removeLabelIds: mutation.removeLabelIds\r\n          }\r\n        });\r\n        \r\n        // Extract and use rate limit info\r\n        const rateLimitInfo = GmailRateLimiter.extractRateLimitInfo(response.headers);\r\n        console.log('BatchUpdateEmails - Rate limit info:', rateLimitInfo);\r\n        rateLimiter.calculateDelay(rateLimitInfo);\r\n        \r\n        // Verify the batch operation results\r\n        const chunkResults = await this.verifyBatchResults(gmail, chunk, mutation);\r\n        allResults.push(...chunkResults);\r\n        \r\n        // Retry failures individually\r\n        const failures = chunkResults.filter(r => !r.success);\r\n        if (failures.length > 0) {\r\n          console.log(`BatchUpdateEmails - Retrying ${failures.length} failed messages individually`);\r\n          \r\n          for (const failed of failures) {\r\n            const retryResult = await this.retryIndividualMessage(\r\n              gmail,\r\n              failed.id,\r\n              mutation,\r\n              rateLimiter\r\n            );\r\n            \r\n            // Update the result\r\n            const index = allResults.findIndex(r => r.id === failed.id);\r\n            if (index !== -1) {\r\n              allResults[index] = retryResult;\r\n            }\r\n          }\r\n        }\r\n        \r\n      } catch (error: any) {\r\n        console.error(`BatchUpdateEmails - Chunk ${chunkIndex} failed:`, error);\r\n        \r\n        // Handle rate limiting\r\n        if (error.code === 429) {\r\n          const retryAfter = error.response?.headers?.['retry-after'];\r\n          const delay = rateLimiter.handle429(retryAfter);\r\n          console.log(`BatchUpdateEmails - Rate limited, waiting ${delay}ms`);\r\n          await rateLimiter.wait();\r\n          \r\n          // Retry the chunk\r\n          i--; // Retry this chunk\r\n          continue;\r\n        }\r\n        \r\n        // Mark all messages in chunk as failed\r\n        chunk.forEach(id => {\r\n          allResults.push({\r\n            id,\r\n            success: false,\r\n            error: error.message || 'Batch operation failed'\r\n          });\r\n        });\r\n      }\r\n    }\r\n    \r\n    return allResults;\r\n  }\r\n\r\n  private async verifyBatchResults(\r\n    gmail: gmail_v1.Gmail,\r\n    messageIds: string[],\r\n    mutation: { addLabelIds: string[]; removeLabelIds: string[] }\r\n  ): Promise<MessageVerification[]> {\r\n    // Verify in parallel with concurrency limit\r\n    const verifyPromises = messageIds.map(id => \r\n      this.createThrottledVerification(gmail, id, mutation)\r\n    );\r\n    \r\n    // Process with limited concurrency\r\n    const results: MessageVerification[] = [];\r\n    const limit = BatchUpdateEmailsHandler.PARALLEL_VERIFY_LIMIT;\r\n    \r\n    for (let i = 0; i < verifyPromises.length; i += limit) {\r\n      const batch = verifyPromises.slice(i, i + limit);\r\n      const batchResults = await Promise.all(batch);\r\n      results.push(...batchResults);\r\n    }\r\n    \r\n    return results;\r\n  }\r\n\r\n  private async createThrottledVerification(\r\n    gmail: gmail_v1.Gmail,\r\n    messageId: string,\r\n    mutation: { addLabelIds: string[]; removeLabelIds: string[] }\r\n  ): Promise<MessageVerification> {\r\n    try {\r\n      const message = await gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: messageId,\r\n        format: 'minimal'\r\n      });\r\n      \r\n      const currentLabels = message.data.labelIds || [];\r\n      \r\n      // Check if changes were applied\r\n      const expectedAdded = mutation.addLabelIds.every(label => \r\n        currentLabels.includes(label)\r\n      );\r\n      const expectedRemoved = mutation.removeLabelIds.every(label => \r\n        !currentLabels.includes(label)\r\n      );\r\n      \r\n      const success = expectedAdded && expectedRemoved;\r\n      \r\n      return {\r\n        id: messageId,\r\n        success,\r\n        postLabels: currentLabels,\r\n        error: success ? undefined : 'Labels not updated as expected'\r\n      };\r\n    } catch (error: any) {\r\n      return {\r\n        id: messageId,\r\n        success: false,\r\n        error: `Verification failed: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  private async retryIndividualMessage(\r\n    gmail: gmail_v1.Gmail,\r\n    messageId: string,\r\n    mutation: { addLabelIds: string[]; removeLabelIds: string[] },\r\n    rateLimiter: GmailRateLimiter\r\n  ): Promise<MessageVerification> {\r\n    try {\r\n      // First check if the message can be modified\r\n      const preCheck = await gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: messageId,\r\n        format: 'minimal'\r\n      });\r\n      \r\n      const currentLabels = preCheck.data.labelIds || [];\r\n      \r\n      // Check if labels can be modified (TRASH/SPAM restrictions)\r\n      if (!LabelMutationBuilder.canModifyLabels(currentLabels, mutation)) {\r\n        return {\r\n          id: messageId,\r\n          success: false,\r\n          preLabels: currentLabels,\r\n          skippedReason: 'Message in TRASH/SPAM - label modifications not allowed'\r\n        };\r\n      }\r\n      \r\n      // Attempt the modification\r\n      await gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: messageId,\r\n        requestBody: {\r\n          addLabelIds: mutation.addLabelIds,\r\n          removeLabelIds: mutation.removeLabelIds\r\n        }\r\n      });\r\n      \r\n      // Wait a bit for consistency\r\n      await new Promise(resolve => setTimeout(resolve, 100));\r\n      \r\n      // Verify the change actually took effect\r\n      const postCheck = await gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: messageId,\r\n        format: 'minimal'\r\n      });\r\n      \r\n      const finalLabels = postCheck.data.labelIds || [];\r\n      \r\n      // Verify changes were applied\r\n      const expectedAdded = mutation.addLabelIds.every(label => \r\n        finalLabels.includes(label)\r\n      );\r\n      const expectedRemoved = mutation.removeLabelIds.every(label => \r\n        !finalLabels.includes(label)\r\n      );\r\n      \r\n      const success = expectedAdded && expectedRemoved;\r\n      \r\n      return {\r\n        id: messageId,\r\n        success,\r\n        preLabels: currentLabels,\r\n        postLabels: finalLabels,\r\n        error: success ? undefined : 'Retry succeeded but verification failed'\r\n      };\r\n      \r\n    } catch (error: any) {\r\n      // Check for rate limiting\r\n      if (error.code === 429) {\r\n        const retryAfter = error.response?.headers?.['retry-after'];\r\n        rateLimiter.handle429(retryAfter);\r\n      }\r\n      \r\n      return {\r\n        id: messageId,\r\n        success: false,\r\n        error: `Individual retry failed: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  private chunkArray<T>(array: T[], size: number): T[][] {\r\n    const chunks: T[][] = [];\r\n    for (let i = 0; i < array.length; i += size) {\r\n      chunks.push(array.slice(i, i + size));\r\n    }\r\n    return chunks;\r\n  }\r\n}", "/**\r\n * Rate limiter with exponential backoff based on Gmail API rate limit headers\r\n */\r\n\r\nexport interface RateLimitInfo {\r\n  limit?: number;\r\n  remaining?: number;\r\n  reset?: number;\r\n}\r\n\r\nexport class GmailRateLimiter {\r\n  private static readonly MIN_DELAY = 100; // 100ms\r\n  private static readonly MAX_DELAY = 60000; // 60s\r\n  private static readonly BACKOFF_MULTIPLIER = 2;\r\n  private static readonly LOW_QUOTA_THRESHOLD = 0.1; // 10% remaining\r\n  \r\n  private currentDelay = GmailRateLimiter.MIN_DELAY;\r\n  private consecutiveErrors = 0;\r\n\r\n  /**\r\n   * Extract rate limit info from response headers\r\n   * Headers can be in various cases: x-ratelimit-limit, X-RateLimit-Limit, etc.\r\n   */\r\n  static extractRateLimitInfo(headers: any): RateLimitInfo {\r\n    const info: RateLimitInfo = {};\r\n    \r\n    if (!headers) return info;\r\n    \r\n    // Normalize header access\r\n    const getHeader = (name: string): string | undefined => {\r\n      // Try lowercase first (most common)\r\n      const lowercase = name.toLowerCase();\r\n      if (headers[lowercase]) return headers[lowercase];\r\n      \r\n      // Try exact case\r\n      if (headers[name]) return headers[name];\r\n      \r\n      // Try case-insensitive search\r\n      for (const key in headers) {\r\n        if (key.toLowerCase() === lowercase) {\r\n          return headers[key];\r\n        }\r\n      }\r\n      \r\n      return undefined;\r\n    };\r\n    \r\n    const limit = getHeader('x-ratelimit-limit');\r\n    const remaining = getHeader('x-ratelimit-remaining');\r\n    const reset = getHeader('x-ratelimit-reset');\r\n    \r\n    if (limit) info.limit = parseInt(limit);\r\n    if (remaining) info.remaining = parseInt(remaining);\r\n    if (reset) info.reset = parseInt(reset);\r\n    \r\n    return info;\r\n  }\r\n\r\n  /**\r\n   * Calculate delay based on rate limit info and error status\r\n   */\r\n  calculateDelay(rateLimitInfo: RateLimitInfo, isError: boolean = false): number {\r\n    if (isError) {\r\n      this.consecutiveErrors++;\r\n      // Exponential backoff on errors\r\n      this.currentDelay = Math.min(\r\n        this.currentDelay * Math.pow(GmailRateLimiter.BACKOFF_MULTIPLIER, this.consecutiveErrors),\r\n        GmailRateLimiter.MAX_DELAY\r\n      );\r\n      return this.currentDelay;\r\n    }\r\n    \r\n    // Reset on success\r\n    this.consecutiveErrors = 0;\r\n    \r\n    // If we have rate limit info, use it\r\n    if (rateLimitInfo.limit && rateLimitInfo.remaining !== undefined) {\r\n      const quotaUsedRatio = 1 - (rateLimitInfo.remaining / rateLimitInfo.limit);\r\n      \r\n      // If quota is running low, increase delay\r\n      if (quotaUsedRatio > (1 - GmailRateLimiter.LOW_QUOTA_THRESHOLD)) {\r\n        // Scale delay based on how close we are to the limit\r\n        const scaleFactor = 1 + (quotaUsedRatio - 0.9) * 10; // 1x to 2x scaling\r\n        this.currentDelay = Math.min(\r\n          GmailRateLimiter.MIN_DELAY * scaleFactor * 10,\r\n          GmailRateLimiter.MAX_DELAY\r\n        );\r\n      } else {\r\n        // Normal operation\r\n        this.currentDelay = GmailRateLimiter.MIN_DELAY;\r\n      }\r\n    }\r\n    \r\n    return this.currentDelay;\r\n  }\r\n\r\n  /**\r\n   * Wait for the calculated delay\r\n   */\r\n  async wait(): Promise<void> {\r\n    if (this.currentDelay > 0) {\r\n      await new Promise(resolve => setTimeout(resolve, this.currentDelay));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle 429 rate limit error with retry-after header\r\n   */\r\n  handle429(retryAfter?: string): number {\r\n    if (retryAfter) {\r\n      // Retry-After can be seconds or HTTP date\r\n      const seconds = parseInt(retryAfter);\r\n      if (!isNaN(seconds)) {\r\n        this.currentDelay = seconds * 1000;\r\n      } else {\r\n        // Try parsing as date\r\n        const retryDate = new Date(retryAfter).getTime();\r\n        if (!isNaN(retryDate)) {\r\n          this.currentDelay = Math.max(0, retryDate - Date.now());\r\n        }\r\n      }\r\n    } else {\r\n      // No retry-after, use exponential backoff\r\n      this.consecutiveErrors++;\r\n      this.currentDelay = Math.min(\r\n        1000 * Math.pow(GmailRateLimiter.BACKOFF_MULTIPLIER, this.consecutiveErrors),\r\n        GmailRateLimiter.MAX_DELAY\r\n      );\r\n    }\r\n    \r\n    return this.currentDelay;\r\n  }\r\n}", "import { CallToolRequestSchema } from \"@modelcontextprotocol/sdk/types.js\";\r\nimport { OAuth2Client } from 'google-auth-library';\r\nimport { BaseToolHandler } from \"./core/BaseToolHandler.js\";\r\nimport { ListCalendarsHandler } from \"./core/ListCalendarsHandler.js\";\r\nimport { ListEventsHandler } from \"./core/ListEventsHandler.js\";\r\nimport { SearchEventsHandler } from \"./core/SearchEventsHandler.js\";\r\nimport { ListColorsHandler } from \"./core/ListColorsHandler.js\";\r\nimport { CreateEventHandler } from \"./core/CreateEventHandler.js\";\r\nimport { UpdateEventHandler } from \"./core/UpdateEventHandler.js\";\r\nimport { DeleteEventHandler } from \"./core/DeleteEventHandler.js\";\r\nimport { FreeBusyEventHandler } from \"./core/FreeBusyEventHandler.js\";\r\nimport { ListContactsHandler } from \"./core/contacts/ListContactsHandler.js\";\r\nimport { GetContactHandler } from \"./core/contacts/GetContactHandler.js\";\r\nimport { CreateContactHandler } from \"./core/contacts/CreateContactHandler.js\";\r\nimport { UpdateContactHandler } from \"./core/contacts/UpdateContactHandler.js\";\r\nimport { DeleteContactHandler } from \"./core/contacts/DeleteContactHandler.js\";\r\nimport { ListEmailsHandler } from \"./core/gmail/ListEmailsHandler.js\";\r\nimport { GetEmailHandler } from \"./core/gmail/GetEmailHandler.js\";\r\nimport { SendEmailHandler } from \"./core/gmail/SendEmailHandler.js\";\r\nimport { UpdateEmailHandler } from \"./core/gmail/UpdateEmailHandler.js\";\r\nimport { DeleteEmailHandler } from \"./core/gmail/DeleteEmailHandler.js\";\r\nimport { CreateDraftHandler } from \"./core/gmail/CreateDraftHandler.js\";\r\nimport { UpdateDraftHandler } from \"./core/gmail/UpdateDraftHandler.js\";\r\nimport { SendDraftHandler } from \"./core/gmail/SendDraftHandler.js\";\r\nimport { ListLabelsHandler } from \"./core/gmail/ListLabelsHandler.js\";\r\nimport { CreateLabelHandler } from \"./core/gmail/CreateLabelHandler.js\";\r\nimport { UpdateLabelHandler } from \"./core/gmail/UpdateLabelHandler.js\";\r\nimport { DeleteLabelHandler } from \"./core/gmail/DeleteLabelHandler.js\";\r\nimport { BatchUpdateEmailsHandler } from \"./core/gmail/BatchUpdateEmailsHandler.js\";\r\n\r\n/**\r\n * Handles incoming tool calls, validates arguments, calls the appropriate service,\r\n * and formats the response.\r\n *\r\n * @param request The CallToolRequest containing tool name and arguments.\r\n * @param oauth2Client The authenticated OAuth2 client instance.\r\n * @returns A Promise resolving to the CallToolResponse.\r\n */\r\nexport async function handleCallTool(request: typeof CallToolRequestSchema._type, oauth2Client: OAuth2Client) {\r\n    const { name, arguments: args } = request.params;\r\n\r\n    try {\r\n        const handler = getHandler(name);\r\n        return await handler.runTool(args, oauth2Client);\r\n    } catch (error: unknown) {\r\n        console.error(`Error executing tool '${name}':`, error);\r\n        // Re-throw the error to be handled by the main server logic or error handler\r\n        throw error;\r\n    }\r\n}\r\n\r\nconst handlerMap: Record<string, BaseToolHandler> = {\r\n    // Calendar handlers\r\n    \"list-calendars\": new ListCalendarsHandler(),\r\n    \"list-events\": new ListEventsHandler(),\r\n    \"search-events\": new SearchEventsHandler(),\r\n    \"list-colors\": new ListColorsHandler(),\r\n    \"create-event\": new CreateEventHandler(),\r\n    \"update-event\": new UpdateEventHandler(),\r\n    \"delete-event\": new DeleteEventHandler(),\r\n    \"get-freebusy\": new FreeBusyEventHandler(),\r\n    // Contact handlers\r\n    \"list-contacts\": new ListContactsHandler(),\r\n    \"get-contact\": new GetContactHandler(),\r\n    \"create-contact\": new CreateContactHandler(),\r\n    \"update-contact\": new UpdateContactHandler(),\r\n    \"delete-contact\": new DeleteContactHandler(),\r\n    // Gmail handlers\r\n    \"list-emails\": new ListEmailsHandler(),\r\n    \"get-email\": new GetEmailHandler(),\r\n    \"send-email\": new SendEmailHandler(),\r\n    \"update-email\": new UpdateEmailHandler(),\r\n    \"delete-email\": new DeleteEmailHandler(),\r\n    \"create-draft\": new CreateDraftHandler(),\r\n    \"update-draft\": new UpdateDraftHandler(),\r\n    \"send-draft\": new SendDraftHandler(),\r\n    \"list-labels\": new ListLabelsHandler(),\r\n    \"create-label\": new CreateLabelHandler(),\r\n    \"update-label\": new UpdateLabelHandler(),\r\n    \"delete-label\": new DeleteLabelHandler(),\r\n    \"batch-update-emails\": new BatchUpdateEmailsHandler(),\r\n};\r\n\r\nfunction getHandler(toolName: string): BaseToolHandler {\r\n    const handler = handlerMap[toolName];\r\n    if (!handler) {\r\n        throw new Error(`Unknown tool: ${toolName}`);\r\n    }\r\n    return handler;\r\n}\r\n"],
  "mappings": "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",
  "names": ["fileURLToPath", "join", "dirname", "__dirname", "oauth2Client", "OAuth2Client", "fs", "path", "oauth2Client", "tokens", "oauth2Client", "OAuth2Client", "resolve", "GaxiosError", "oauth2Client", "resolve", "oauth2Client", "oauth2Client", "oauth2Client", "oauth2Client", "resolve", "oauth2Client", "oauth2Client", "oauth2Client", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "resolve", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "oauth2Client", "google", "google", "resolve", "oauth2Client", "google", "resolve", "oauth2Client", "fileURLToPath", "dirname", "join", "oauth2Client", "command"]
}
